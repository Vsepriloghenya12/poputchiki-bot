<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ø–æ–ø—É—Ç—á–∏–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e5e7eb; /* —á—É—Ç—å —Ç–µ–º–Ω–µ–µ —Ñ–æ–Ω, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –≤—ã–¥–µ–ª—è–ª–∏—Å—å */
      color: #111827;
    }
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px 12px 60px 12px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 14px 14px 16px 14px;
      margin-bottom: 14px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
      border: 1px solid #e5e7eb;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .logo {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f704db, #10b981);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #374151;
      margin-bottom: 8px;
    }

    .info {
      font-size: 13px;
      color: #4b5563;
      margin-top: 4px;
      white-space: pre-line;
      line-height: 1.4;
    }
    .small-text {
      font-size: 11px;
      color: #6b7280;
    }

    .field {
      margin-bottom: 8px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 3px;
    }
    .field input,
    .field textarea,
    .field select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 7px 9px;
      font-size: 15px;
      box-sizing: border-box;
      background: #f9fafb;
    }
    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
      background: #ffffff;
    }
    .field-inline {
      display: flex;
      gap: 8px;
    }
    .field-inline .field {
      flex: 1;
      margin-bottom: 0;
    }

    .role-buttons {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
        .role-buttons button {
      flex: 1;
      border-radius: 16px;
      padding: 12px 0;
      font-size: 15px;
      font-weight: 700;
      color: #ffffff;
      border: none;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.15s ease;
    }

    #btn-driver {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.4);
    }
    #btn-driver:hover {
      background: linear-gradient(135deg, #1e40af, #1d4ed8);
    }

    #btn-passenger {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 3px 8px rgba(16, 185, 129, 0.4);
    }
    #btn-passenger:hover {
      background: linear-gradient(135deg, #047857, #059669);
    }

    .role-buttons button:active {
      transform: scale(0.97);
      box-shadow: none;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .primary-btn {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
    }
    .primary-btn:hover {
      background: #1d4ed8;
    }
    .secondary-btn {
      background: #e5e7eb;
      color: #111827;
    }
    .secondary-btn:hover {
      background: #d1d5db;
    }
    .danger-btn {
      background: #ef4444;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.35);
    }
    .danger-btn:hover {
      background: #dc2626;
    }

    .trip-card,
    .booking-card,
    .plan-card {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 8px 9px;
      margin-bottom: 8px;
      font-size: 13px;
      background: #f9fafb;
    }

    .trip-header,
    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 6px;
    }
    .trip-route,
    .booking-status {
      font-weight: 700;
      font-size: 14px;
    }
    .booking-status {
      color: #059669;
      white-space: nowrap;
    }
    .trip-meta,
    .booking-meta {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.4;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: #eef2ff;
      color: #3730a3;
      margin-right: 4px;
      margin-top: 2px;
    }

    .hidden {
      display: none !important;
    }

    /* –°–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã: –≤–æ–¥–∏—Ç–µ–ª—å / –ø–∞—Å—Å–∞–∂–∏—Ä / –∞–¥–º–∏–Ω */

    #driver-section,
    #driver-active,
    #driver-history,
    #driver-passenger-plans,
    #driver-payment-block {
      border-left: 4px solid #2563eb;
      padding-left: 12px;
    }

    #passenger-section,
    #passenger-active,
    #passenger-plans-section {
      border-left: 4px solid #10b981;
      padding-left: 12px;
    }

    #admin-section {
      border-left: 4px solid #f97316;
      padding-left: 12px;
    }

    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 10px;
      background: #f3f4f6;
      margin-top: 4px;
    }
    .collapsible-header span {
      font-weight: 600;
      font-size: 14px;
    }
    .arrow {
      font-size: 16px;
      transition: transform 0.15s ease;
    }
    .arrow.rotated {
      transform: rotate(90deg);
    }
        .card-collapsible-content {
      margin-top: 8px;
    }
    .card-collapsed .card-collapsible-content {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –®–∞–ø–∫–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º -->
    <div class="card">
      <div class="title-row">
        <div class="logo">üöó</div>
        <div class="title">–ø–æ–ø—É—Ç—á–∏–∫–∏</div>
      </div>
      <div class="info" id="user-info">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...
      </div>
    </div>

    <!-- –í—ã–±–æ—Ä —Ä–æ–ª–∏ -->
    <div class="card">
      <div class="subtitle">–ö—Ç–æ –≤—ã?</div>
      <div class="role-buttons">
        <button class="secondary-btn" id="btn-driver">–Ø –≤–æ–¥–∏—Ç–µ–ª—å</button>
        <button class="secondary-btn" id="btn-passenger">–Ø –ø–∞—Å—Å–∞–∂–∏—Ä</button>
      </div>
      <div class="info" id="role-info">
        –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.
      </div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏ + –º–∞—à–∏–Ω–∞ -->
        <div class="card hidden" id="driver-section"
         data-collapsible="1" data-title="–í–æ–¥–∏—Ç–µ–ª—å: –ø–æ–µ–∑–¥–∫–∞ –∏ –º–∞—à–∏–Ω–∞">
      <div class="subtitle">–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</div>

      <div class="field">
        <label for="from-city">–û—Ç–∫—É–¥–∞</label>
        <input id="from-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ—á–∏" />
      </div>
      <div class="field">
        <label for="to-city">–ö—É–¥–∞</label>
        <input id="to-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–æ–∑–∞ –ü–ª–∞—Ç–æ" />
      </div>
      <div class="field">
        <label for="departure-time">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤—ã–µ–∑–¥–∞</label>
        <input id="departure-time" type="datetime-local" />
      </div>
      <div class="field field-inline">
        <div class="field">
          <label for="seats-total">–ú–µ—Å—Ç</label>
          <input id="seats-total" type="number" min="1" max="8" value="3" />
        </div>
        <div class="field">
          <label for="price-per-seat">–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ</label>
          <input id="price-per-seat" type="number" min="0" step="10" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" />
        </div>
      </div>
      <div class="field">
        <label for="trip-note">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <input id="trip-note" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –µ–¥—É —á–µ—Ä–µ–∑ –†–æ–∑—É –•–æ–ª–ª" />
      </div>

      <button class="primary-btn" id="btn-create-trip">–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
      <div class="info" id="driver-message"></div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;" />

      <div class="subtitle">–ú–æ—è –º–∞—à–∏–Ω–∞</div>
      <div class="field field-inline">
        <div class="field">
          <label for="car-make">–ú–∞—Ä–∫–∞ / –º–æ–¥–µ–ª—å</label>
          <input id="car-make" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Kia Rio" />
        </div>
        <div class="field">
          <label for="car-color">–¶–≤–µ—Ç</label>
          <input id="car-color" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–ª—ã–π" />
        </div>
      </div>
      <div class="field">
        <label for="car-plate">–ù–æ–º–µ—Ä</label>
        <input id="car-plate" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê123–í–° 123" />
      </div>
      <button class="secondary-btn" id="btn-save-car">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—à–∏–Ω—É</button>
      <div class="info" id="driver-car-message"></div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ -->
        <div class="card hidden" id="driver-active"
         data-collapsible="1" data-title="–í–æ–¥–∏—Ç–µ–ª—å: –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞">
      <div class="subtitle">–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞</div>
      <div class="info small-text">
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–ª–∏–∂–∞–π—à–∞—è –ø–æ–µ–∑–¥–∫–∞ (–≤–∫–ª—é—á–∞—è 10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞).
      </div>
      <button class="secondary-btn" id="btn-load-active-trip">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <div class="info" id="driver-active-info">
        –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button class="secondary-btn" id="btn-active-passengers">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button>
        <button class="danger-btn" id="btn-cancel-active-trip">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
      </div>
      <div class="info" id="driver-bookings-title" style="margin-top:8px;"></div>
      <div id="driver-bookings-list"></div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –∏—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫ -->
        <div class="card hidden" id="driver-history"
         data-collapsible="1" data-title="–í–æ–¥–∏—Ç–µ–ª—å: –º–æ–∏ –ø–æ–µ–∑–¥–∫–∏">
      <div class="subtitle">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</div>
      <button class="secondary-btn" id="btn-load-driver-trips">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      <div class="info" id="driver-trips-list">
        –ü–æ–µ–∑–¥–∫–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ -->
        <div class="card hidden" id="driver-passenger-plans">
      <div class="collapsible-header" id="driver-passenger-plans-header">
        <span>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤</span>
        <span class="arrow" id="driver-passenger-plans-arrow">‚ñ∂</span>
      </div>
      <div class="info small-text">
        –ó–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–±—Ä–∞—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞¬ª, —á—Ç–æ–±—ã –µ–º—É –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        ¬´–í–∞—Å –∑–∞–±–µ—Ä—ë—Ç –≤–æ–¥–∏—Ç–µ–ª—å¬ª.
      </div>
      <div id="driver-passenger-plans-content" class="hidden" style="margin-top:8px;">
        <div class="info" id="driver-passenger-plans-list">
          –ó–∞–ø—Ä–æ—Å—ã –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
        </div>
        <button class="secondary-btn" id="btn-reload-driver-passenger-plans" style="margin-top:6px;">
          –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
        </button>
      </div>
    </div>

    <!-- –ü–∞—Å—Å–∞–∂–∏—Ä: —Å–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫ -->
        <div class="card hidden" id="passenger-section"
         data-collapsible="1" data-title="–ü–∞—Å—Å–∞–∂–∏—Ä: –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏">
      <div class="subtitle">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</div>
      <div class="info small-text">
        –°–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫ —Å –µ—â—ë —Å–≤–æ–±–æ–¥–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏ –∏ —Å –≤—ã–µ–∑–¥–æ–º –Ω–µ —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥.
      </div>
      <div id="trips-list" class="info">
        –ü–æ–µ–∑–¥–∫–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –ü–∞—Å—Å–∞–∂–∏—Ä: –º–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ -->
        <div class="card hidden" id="passenger-active"
         data-collapsible="1" data-title="–ü–∞—Å—Å–∞–∂–∏—Ä: –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏">
      <div class="subtitle">–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
      <button class="secondary-btn" id="btn-load-passenger-active">–ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</button>
      <div class="info" id="passenger-active-list">
        –ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –ü–∞—Å—Å–∞–∂–∏—Ä: –ø–ª–∞–Ω—ã –ø–æ–µ–∑–¥–æ–∫ -->
        <div class="card hidden" id="passenger-plans-section"
         data-collapsible="1" data-title="–ü–∞—Å—Å–∞–∂–∏—Ä: –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏">
      <div class="subtitle">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</div>
      <div class="field">
        <label for="plan-from-city">–û—Ç–∫—É–¥–∞</label>
        <input id="plan-from-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ—á–∏" />
      </div>
      <div class="field">
        <label for="plan-to-city">–ö—É–¥–∞</label>
        <input id="plan-to-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–æ–∑–∞ –ü–ª–∞—Ç–æ" />
      </div>
      <div class="field">
        <label for="plan-desired-time">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
        <input id="plan-desired-time" type="datetime-local" />
      </div>
      <div class="field">
        <label for="plan-seats-needed">–°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –Ω—É–∂–Ω–æ</label>
        <input id="plan-seats-needed" type="number" min="1" max="8" value="1" />
      </div>
      <div class="field">
        <label for="plan-note">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <input id="plan-note" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–¥–æ–π–¥—ë—Ç –≤—ã–µ–∑–¥ —Å 8 –¥–æ 10 —É—Ç—Ä–∞" />
      </div>
      <button class="secondary-btn" id="btn-create-passenger-plan">–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –ø–æ–µ–∑–¥–∫–∏</button>
      <div class="info" id="passenger-plan-message"></div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;" />

      <div class="subtitle">–ú–æ–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</div>
      <div class="info small-text">
        –ö–æ–≥–¥–∞ –≤–æ–¥–∏—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤–∞—à –ø–ª–∞–Ω, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–í–∞—Å –∑–∞–±–µ—Ä—ë—Ç –≤–æ–¥–∏—Ç–µ–ª—å¬ª.
      </div>
      <div class="info" id="passenger-plans-list">
        –ü–ª–∞–Ω—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –±–ª–æ–∫ –æ–ø–ª–∞—Ç—ã -->
        <div class="card hidden" id="driver-payment-block"
         data-collapsible="1" data-title="–í–æ–¥–∏—Ç–µ–ª—å: –æ–ø–ª–∞—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏">
      <div class="subtitle">–û–ø–ª–∞—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
      <div class="info" id="driver-payment-info">
        –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –ø–æ–µ–∑–¥–∫–∞—Ö.
      </div>
      <div class="info" id="driver-payment-requisites"></div>

      <div class="field hidden" id="driver-payment-copy-block">
        <label for="driver-payment-details-copy">–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</label>
        <textarea
          id="driver-payment-details-copy"
          rows="3"
          readonly
          style="width:100%;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:13px;"
        ></textarea>
        <button class="secondary-btn" id="btn-copy-payment-details" type="button">
          –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
        </button>
      </div>

      <div class="field">
        <label for="driver-payment-file">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫ –æ–± –æ–ø–ª–∞—Ç–µ</label>
        <input id="driver-payment-file" type="file" />
      </div>
      <button class="secondary-btn" id="btn-upload-payment">–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫</button>
    </div>

    <!-- –ê–¥–º–∏–Ω: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–ª–∞—Ç–æ–π -->
        <div class="card hidden" id="admin-section"
         data-collapsible="1" data-title="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å">
      <div class="subtitle">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å–µ—Ä–≤–∏—Å–∞</div>

      <div class="info" id="admin-settings-info">
        –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫.
      </div>

      <div class="field">
        <label for="admin-payment-details">–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã</label>
        <textarea
          id="admin-payment-details"
          rows="3"
          style="width:100%;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:13px;"
        ></textarea>
      </div>

      <div class="role-buttons" style="margin-top:4px;">
        <button class="secondary-btn" id="btn-disable-pay">–°–¥–µ–ª–∞—Ç—å —Å–µ—Ä–≤–∏—Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º</button>
        <button class="primary-btn" id="btn-enable-pay">–í–∫–ª—é—á–∏—Ç—å –æ–ø–ª–∞—Ç—É –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π</button>
      </div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;" />

      <div class="subtitle">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <button class="secondary-btn" id="btn-load-stats">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
      <div class="info" id="admin-stats-info">
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.
      </div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;" />

      <div class="subtitle">–í–æ–¥–∏—Ç–µ–ª–∏ –∑–∞ –¥–µ–Ω—å</div>
      <div class="field">
        <label for="admin-drivers-date">–î–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <input id="admin-drivers-date" type="date" />
      </div>
      <button class="secondary-btn" id="btn-load-daily-drivers">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π</button>
      <div class="info" id="admin-daily-drivers">
        –°–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    const ADMIN_ID = 504348666;

    let currentTelegramUser = null;
    let activeTripId = null;

    const userInfoDiv = document.getElementById('user-info');
    userInfoDiv.innerHTML += `<br/>URL: ${window.location.href}`;
    const btnDriver = document.getElementById('btn-driver');
    const btnPassenger = document.getElementById('btn-passenger');
    const roleInfo = document.getElementById('role-info');

    const driverSection = document.getElementById('driver-section');
    const driverHistory = document.getElementById('driver-history');
    const driverActive = document.getElementById('driver-active');

    const passengerSection = document.getElementById('passenger-section');
    const passengerActiveSection = document.getElementById('passenger-active');
    const driverMessage = document.getElementById('driver-message');
    const tripsList = document.getElementById('trips-list');

    const btnLoadDriverTrips = document.getElementById('btn-load-driver-trips');
    const driverTripsList = document.getElementById('driver-trips-list');
    const driverBookingsTitle = document.getElementById('driver-bookings-title');
    const driverBookingsList = document.getElementById('driver-bookings-list');

    const btnLoadActiveTrip = document.getElementById('btn-load-active-trip');
    const btnActivePassengers = document.getElementById('btn-active-passengers');
    const btnCancelActiveTrip = document.getElementById('btn-cancel-active-trip');
    const driverActiveInfo = document.getElementById('driver-active-info');

    const driverCarMessage = document.getElementById('driver-car-message');

    const driverPaymentBlock = document.getElementById('driver-payment-block');
    const driverPaymentInfo = document.getElementById('driver-payment-info');
    const driverPaymentRequisites = document.getElementById('driver-payment-requisites');
    const driverPaymentCopyBlock = document.getElementById('driver-payment-copy-block');
    const driverPaymentDetailsCopy = document.getElementById('driver-payment-details-copy');
    const btnCopyPaymentDetails = document.getElementById('btn-copy-payment-details');
    const driverPaymentFile = document.getElementById('driver-payment-file');
    const btnUploadPayment = document.getElementById('btn-upload-payment');

    const adminSection = document.getElementById('admin-section');
    const adminSettingsInfo = document.getElementById('admin-settings-info');
    const adminPaymentDetails = document.getElementById('admin-payment-details');
    const btnEnablePay = document.getElementById('btn-enable-pay');
    const btnDisablePay = document.getElementById('btn-disable-pay');

    const btnLoadStats = document.getElementById('btn-load-stats');
    const adminStatsInfo = document.getElementById('admin-stats-info');

    const btnLoadDailyDrivers = document.getElementById('btn-load-daily-drivers');
    const adminDailyDrivers = document.getElementById('admin-daily-drivers');
    const adminDriversDate = document.getElementById('admin-drivers-date');

    const btnLoadPassengerActive = document.getElementById('btn-load-passenger-active');
    const passengerActiveList = document.getElementById('passenger-active-list');

    // –ü–ª–∞–Ω—ã –ø–æ–µ–∑–¥–æ–∫ –ø–∞—Å—Å–∞–∂–∏—Ä–∞
    const passengerPlansSection = document.getElementById('passenger-plans-section');
    const planFromCityInput = document.getElementById('plan-from-city');
    const planToCityInput = document.getElementById('plan-to-city');
    const planDesiredTimeInput = document.getElementById('plan-desired-time');
    const planSeatsNeededInput = document.getElementById('plan-seats-needed');
    const planNoteInput = document.getElementById('plan-note');
    const btnCreatePassengerPlan = document.getElementById('btn-create-passenger-plan');
    const passengerPlanMessage = document.getElementById('passenger-plan-message');
    const passengerPlansList = document.getElementById('passenger-plans-list');

    // –ü–ª–∞–Ω—ã –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è
    const driverPassengerPlansCard = document.getElementById('driver-passenger-plans');
    const driverPassengerPlansHeader = document.getElementById('driver-passenger-plans-header');
    const driverPassengerPlansArrow = document.getElementById('driver-passenger-plans-arrow');
    const driverPassengerPlansContent = document.getElementById('driver-passenger-plans-content');
    const driverPassengerPlansList = document.getElementById('driver-passenger-plans-list');
    const btnReloadDriverPassengerPlans = document.getElementById('btn-reload-driver-passenger-plans');

    function isStillActiveByDeparture(departureTimeStr) {
      if (!departureTimeStr) return true;
      const ts = Date.parse(departureTimeStr);
      if (!Number.isFinite(ts)) return true;
      const now = Date.now();
      const cutoff = now - 10 * 60 * 1000;
      return ts >= cutoff;
    }
        // –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏: —Å—á–∏—Ç–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ç–æ–ª—å–∫–æ –¥–æ 20 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∂–µ–ª–∞–µ–º–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–µ–∑–¥–∞
    function isPlanStillActive(desiredTimeStr) {
      if (!desiredTimeStr) return true;
      const ts = Date.parse(desiredTimeStr);
      if (!Number.isFinite(ts)) return true;
      const now = Date.now();
      const cutoff = now - 20 * 60 * 1000; // 20 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
      return ts >= cutoff;
    }

    function formatName(first, last, username) {
      const full = `${first || ''} ${last || ''}`.trim();
      const u = username ? ` @${username}` : '';
      return (full || '–±–µ–∑ –∏–º–µ–Ω–∏') + u;
    }
          function formatDateReadable(str) {
      if (!str) return str;
          // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏: –ª—é–±–∞—è .card —Å data-collapsible="1"
        // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏: –ª—é–±–∞—è .card —Å data-collapsible="1"
    (function initCollapsibleCards() {
      const cards = document.querySelectorAll('.card[data-collapsible="1"]');

      cards.forEach((card) => {
        // –µ—Å–ª–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ ‚Äî –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏
        if (card.dataset.collapsibleInitialized === '1') return;
        card.dataset.collapsibleInitialized = '1';

        const titleAttr = card.getAttribute('data-title');
        let titleText = titleAttr && titleAttr.trim();

        if (!titleText) {
          const firstSubtitle = card.querySelector('.subtitle');
          titleText = firstSubtitle ? firstSubtitle.textContent.trim() : '–ë–ª–æ–∫';
        }

        // –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –æ–±—ë—Ä—Ç–∫—É
        const content = document.createElement('div');
        content.className = 'card-collapsible-content';
        while (card.firstChild) {
          content.appendChild(card.firstChild);
        }

        // —Å–æ–∑–¥–∞—ë–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
        const header = document.createElement('div');
        header.className = 'collapsible-header';

        const titleSpan = document.createElement('span');
        titleSpan.textContent = titleText;

        const arrow = document.createElement('span');
        arrow.className = 'arrow';
        arrow.textContent = '‚ñ∂';

        header.appendChild(titleSpan);
        header.appendChild(arrow);

        card.appendChild(header);
        card.appendChild(content);

        // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Å–≤—ë—Ä–Ω—É—Ç–æ
        card.classList.add('card-collapsed');

        header.addEventListener('click', () => {
          const collapsed = card.classList.toggle('card-collapsed');
          if (collapsed) {
            arrow.classList.remove('rotated');
          } else {
            arrow.classList.add('rotated');
          }
        });
      });
    })();

      const d = new Date(str);
      if (isNaN(d.getTime())) return str;

      const day = d.getDate();
      const month = d.getMonth();
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');

      const MONTHS = [
        "—è–Ω–≤–∞—Ä—è",
        "—Ñ–µ–≤—Ä–∞–ª—è",
        "–º–∞—Ä—Ç–∞",
        "–∞–ø—Ä–µ–ª—è",
        "–º–∞—è",
        "–∏—é–Ω—è",
        "–∏—é–ª—è",
        "–∞–≤–≥—É—Å—Ç–∞",
        "—Å–µ–Ω—Ç—è–±—Ä—è",
        "–æ–∫—Ç—è–±—Ä—è",
        "–Ω–æ—è–±—Ä—è",
        "–¥–µ–∫–∞–±—Ä—è"
      ];

      return `${day} ${MONTHS[month]}, ${hours}:${minutes}`;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ Telegram
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      tg.expand();
      currentTelegramUser = tg.initDataUnsafe.user;

      userInfoDiv.textContent =
        `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${currentTelegramUser.first_name || ''} ${currentTelegramUser.last_name || ''} (@${currentTelegramUser.username || '–±–µ–∑ username'})`;

      fetch('/api/init-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: currentTelegramUser }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            console.error('–û—à–∏–±–∫–∞ init-user:', data.error);
          }
          if (currentTelegramUser && String(currentTelegramUser.id) === String(ADMIN_ID)) {
            adminSection.classList.remove('hidden');
            loadAdminSettings();
          } else {
            adminSection.classList.add('hidden');
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ init-user:', err);
        });
    } else {
      userInfoDiv.textContent =
        '–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.';
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π
    btnDriver.addEventListener('click', () => {
      if (!currentTelegramUser) {
        roleInfo.textContent =
          '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º –≤–æ–¥–∏—Ç–µ–ª—è.';
        return;
      }
      roleInfo.textContent =
        '–†–µ–∂–∏–º –≤–æ–¥–∏—Ç–µ–ª—è: —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–æ–µ–∑–¥–∫–∏, —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –º–∞—à–∏–Ω—É, —Å–º–æ—Ç—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–µ–∑–¥–∫—É –∏ –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤.';
      driverSection.classList.remove('hidden');
      driverHistory.classList.remove('hidden');
      driverActive.classList.remove('hidden');
      driverPassengerPlansCard.classList.remove('hidden');
      passengerSection.classList.add('hidden');
      passengerActiveSection.classList.add('hidden');
      passengerPlansSection.classList.add('hidden');
      driverPaymentBlock.classList.remove('hidden');

      loadDriverProfile();
      loadDriverActiveTrip();
      loadDriverPaymentInfo();
      loadDriverTrips();
      loadDriverPassengerPlans();
    });

    btnPassenger.addEventListener('click', () => {
      if (!currentTelegramUser) {
        roleInfo.textContent =
          '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫–∏.';
        return;
      }
      roleInfo.textContent =
        '–†–µ–∂–∏–º –ø–∞—Å—Å–∞–∂–∏—Ä–∞: –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏ –±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –ø–æ–µ–∑–¥–∫–∏, –ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ–µ–∑–¥–∫–∏ –∑–∞—Ä–∞–Ω–µ–µ.';
      passengerSection.classList.remove('hidden');
      passengerActiveSection.classList.remove('hidden');
      passengerPlansSection.classList.remove('hidden');
      driverSection.classList.add('hidden');
      driverHistory.classList.add('hidden');
      driverActive.classList.add('hidden');
      driverPassengerPlansCard.classList.add('hidden');
      driverPaymentBlock.classList.add('hidden');

      loadTrips();
      loadPassengerActiveBookings();
      loadPassengerPlans();
    });

    // –í–æ–¥–∏—Ç–µ–ª—å: –ø—Ä–æ—Ñ–∏–ª—å –º–∞—à–∏–Ω—ã
    function loadDriverProfile() {
      if (!currentTelegramUser) return;

      fetch(`/api/driver/profile?telegram_id=${encodeURIComponent(String(currentTelegramUser.id))}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverCarMessage.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + data.error;
            return;
          }
          const p = data.profile || {};
          document.getElementById('car-make').value = p.car_make || '';
          document.getElementById('car-color').value = p.car_color || '';
          document.getElementById('car-plate').value = p.car_plate || '';
          if (p.car_make || p.car_color || p.car_plate) {
            driverCarMessage.textContent = '–î–∞–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã.';
          } else {
            driverCarMessage.textContent =
              '–£–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã, —á—Ç–æ–±—ã –ø–∞—Å—Å–∞–∂–∏—Ä–∞–º –±—ã–ª–æ –ª–µ–≥—á–µ –≤–∞—Å —É–∑–Ω–∞—Ç—å.';
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/driver/profile (GET):', err);
          driverCarMessage.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è.';
        });
    }

    document.getElementById('btn-save-car').addEventListener('click', () => {
      if (!currentTelegramUser) {
        driverCarMessage.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }
      const carMake = document.getElementById('car-make').value.trim();
      const carColor = document.getElementById('car-color').value.trim();
      const carPlate = document.getElementById('car-plate').value.trim();

      fetch('/api/driver/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          car_make: carMake,
          car_color: carColor,
          car_plate: carPlate,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverCarMessage.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            driverCarMessage.textContent = '–ü—Ä–æ—Ñ–∏–ª—å –º–∞—à–∏–Ω—ã —Å–æ—Ö—Ä–∞–Ω—ë–Ω.';
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/driver/profile (POST):', err);
          driverCarMessage.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.';
        });
    });

    // –í–æ–¥–∏—Ç–µ–ª—å: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏
    document.getElementById('btn-create-trip').addEventListener('click', () => {
      if (!currentTelegramUser) {
        driverMessage.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      const fromCity = document.getElementById('from-city').value.trim();
      const toCity = document.getElementById('to-city').value.trim();
      const departureTime = document.getElementById('departure-time').value;
      const seatsTotal = document.getElementById('seats-total').value;
      const pricePerSeat = document.getElementById('price-per-seat').value;
      const note = document.getElementById('trip-note').value.trim();

      if (!fromCity || !toCity || !departureTime || !seatsTotal || !pricePerSeat) {
        driverMessage.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.';
        return;
      }

      driverMessage.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏...';

      fetch('/api/trips', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          from_city: fromCity,
          to_city: toCity,
          departure_time: departureTime,
          seats_total: seatsTotal,
          price_per_seat: pricePerSeat,
          note,
        }),
      })
        .then((res) => res.json().then((data) => ({ ok: res.ok, data })))
        .then(({ ok, data }) => {
          if (!ok || data.error) {
            driverMessage.textContent =
              '–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É');
          } else {
            driverMessage.textContent = '–ü–æ–µ–∑–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞.';
            document.getElementById('from-city').value = '';
            document.getElementById('to-city').value = '';
            document.getElementById('departure-time').value = '';
            document.getElementById('seats-total').value = '3';
            document.getElementById('price-per-seat').value = '';
            document.getElementById('trip-note').value = '';
            loadDriverTrips();
            loadDriverActiveTrip();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/trips (POST):', err);
          driverMessage.textContent = '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.';
        });
    });

    // –í–æ–¥–∏—Ç–µ–ª—å: –∏—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫
    btnLoadDriverTrips.addEventListener('click', loadDriverTrips);

    function loadDriverTrips() {
      if (!currentTelegramUser) {
        driverTripsList.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      driverTripsList.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–µ–∑–¥–æ–∫...';

      fetch(`/api/driver/trips?telegram_id=${encodeURIComponent(String(currentTelegramUser.id))}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverTripsList.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            renderDriverTrips(data.trips || []);
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/driver/trips:', err);
          driverTripsList.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞.';
        });
    }

    function renderDriverTrips(trips) {
      if (!trips || trips.length === 0) {
        driverTripsList.textContent = '–ü–æ–µ–∑–¥–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.';
        return;
      }

      driverTripsList.innerHTML = '';
      trips.forEach((t) => {
        const div = document.createElement('div');
        div.className = 'trip-card';

        const header = document.createElement('div');
        header.className = 'trip-header';

        const routeSpan = document.createElement('div');
        routeSpan.className = 'trip-route';
        routeSpan.textContent = `${t.from_city} ‚Üí ${t.to_city}`;

        const statusSpan = document.createElement('span');
        statusSpan.className = 'small-text';
        statusSpan.textContent = t.departure_time;

        header.appendChild(routeSpan);
        header.appendChild(statusSpan);

        const meta = document.createElement('div');
        meta.className = 'trip-meta';
        meta.innerHTML =
          `–ú–µ—Å—Ç –≤—Å–µ–≥–æ: ${t.seats_total}, —Å–≤–æ–±–æ–¥–Ω–æ: ${t.seats_available}<br/>` +
          `–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ: ${t.price_per_seat} ‚ÇΩ` +
          (t.note ? `<br/>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${t.note}` : '');

        const footer = document.createElement('div');
        footer.style.marginTop = '4px';
        footer.style.display = 'flex';
        footer.style.gap = '6px';

        const btnShowPassengers = document.createElement('button');
        btnShowPassengers.className = 'secondary-btn';
        btnShowPassengers.textContent = '–ü–∞—Å—Å–∞–∂–∏—Ä—ã';
        btnShowPassengers.addEventListener('click', () => {
          loadTripBookingsForDriver(t.id);
        });

        const btnDelete = document.createElement('button');
        btnDelete.className = 'danger-btn';
        btnDelete.textContent = '–£–¥–∞–ª–∏—Ç—å';
        btnDelete.addEventListener('click', () => {
          deleteDriverTrip(t.id);
        });

        footer.appendChild(btnShowPassengers);
        footer.appendChild(btnDelete);

        div.appendChild(header);
        div.appendChild(meta);
        div.appendChild(footer);

        driverTripsList.appendChild(div);
      });
    }

    function deleteDriverTrip(tripId) {
      if (!currentTelegramUser) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
        return;
      }
      if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –ø–æ–µ–∑–¥–∫—É? –ü–æ –Ω–µ–π –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.')) return;

      fetch('/api/driver/delete-trip', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          trip_id: tripId,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
          } else {
            alert('–ü–æ–µ–∑–¥–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.');
            loadDriverTrips();
            loadDriverActiveTrip();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–µ–∑–¥–∫–∏:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–µ–∑–¥–∫–∏.');
        });
    }

    function loadTripBookingsForDriver(tripId) {
      if (!currentTelegramUser) return;

      fetch(
        `/api/driver/trip-bookings?telegram_id=${encodeURIComponent(
          String(currentTelegramUser.id)
        )}&trip_id=${encodeURIComponent(String(tripId))}`
      )
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverBookingsTitle.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
            driverBookingsList.innerHTML = '';
          } else {
            driverBookingsTitle.textContent = '–ë—Ä–æ–Ω–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–µ–∑–¥–∫–µ:';
            renderDriverTripBookings(data.bookings || []);
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/driver/trip-bookings:', err);
          driverBookingsTitle.textContent =
            '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.';
          driverBookingsList.innerHTML = '';
        });
    }

    function renderDriverTripBookings(bookings) {
      if (!bookings || bookings.length === 0) {
        driverBookingsList.textContent = '–ü–æ —ç—Ç–æ–π –ø–æ–µ–∑–¥–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.';
        return;
      }

      driverBookingsList.innerHTML = '';
      bookings.forEach((b) => {
        const div = document.createElement('div');
        div.className = 'booking-card';

        const header = document.createElement('div');
        header.className = 'booking-header';

        const nameSpan = document.createElement('div');
        nameSpan.textContent = formatName(
          b.passenger_first_name,
          b.passenger_last_name,
          b.passenger_username
        );

        const statusSpan = document.createElement('span');
        statusSpan.className = 'booking-status';
        statusSpan.textContent =
          b.status === 'no_show'
            ? '–Ω–µ –ø—Ä–∏–µ—Ö–∞–ª'
            : b.status === 'cancelled'
            ? '–æ—Ç–º–µ–Ω–µ–Ω–æ'
            : '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ';

        header.appendChild(nameSpan);
        header.appendChild(statusSpan);

        const meta = document.createElement('div');
        meta.className = 'booking-meta';
        meta.innerHTML =
          `–ú–µ—Å—Ç: ${b.seats_booked}<br/>` +
          `–°—É–º–º–∞: ${b.amount_total} ‚ÇΩ (–≤–æ–¥–∏—Ç–µ–ª—é: ${b.driver_amount} ‚ÇΩ, —Å–µ—Ä–≤–∏—Å: ${b.app_fee} ‚ÇΩ)<br/>` +
          `–ù–µ—è–≤–æ–∫ —É –ø–∞—Å—Å–∞–∂–∏—Ä–∞: ${b.passenger_no_show_count || 0}`;

        div.appendChild(header);
        div.appendChild(meta);

        if (b.status === 'booked') {
          const btnNoShow = document.createElement('button');
          btnNoShow.className = 'danger-btn';
          btnNoShow.textContent = '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –Ω–µ –ø—Ä–∏–µ—Ö–∞–ª';
          btnNoShow.addEventListener('click', () => {
            markNoShow(b.id);
          });
          div.appendChild(btnNoShow);
        }

        driverBookingsList.appendChild(div);
      });
    }

    function markNoShow(bookingId) {
      if (!currentTelegramUser) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
        return;
      }
      if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞ –∫–∞–∫ –Ω–µ –ø—Ä–∏–µ—Ö–∞–≤—à–µ–≥–æ?')) return;

      fetch('/api/bookings/no-show', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          booking_id: bookingId,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
          } else {
            alert('–ü–∞—Å—Å–∞–∂–∏—Ä –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –Ω–µ –ø—Ä–∏–µ—Ö–∞–≤—à–∏–π.');
            loadDriverTrips();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ no-show:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞.');
        });
    }

    // –í–æ–¥–∏—Ç–µ–ª—å: –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞
    btnLoadActiveTrip.addEventListener('click', loadDriverActiveTrip);
    btnActivePassengers.addEventListener('click', () => {
      if (activeTripId) {
        loadTripBookingsForDriver(activeTripId);
      } else {
        alert('–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
      }
    });
    btnCancelActiveTrip.addEventListener('click', () => {
      if (!activeTripId) {
        alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏.');
        return;
      }
      deleteDriverTrip(activeTripId);
    });

    function loadDriverActiveTrip() {
      if (!currentTelegramUser) {
        driverActiveInfo.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      driverActiveInfo.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏...';

      fetch(
        `/api/driver/active-trip?telegram_id=${encodeURIComponent(
          String(currentTelegramUser.id)
        )}`
      )
        .then((res) => res.json())
        .then((data) => {
          const t = data.trip;
          if (!t) {
            driverActiveInfo.textContent = '–ê–∫—Ç–∏–≤–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç.';
            activeTripId = null;
            driverBookingsTitle.textContent = '';
            driverBookingsList.innerHTML = '';
            return;
          }

          activeTripId = t.id;
          driverActiveInfo.innerHTML =
            `${t.from_city} ‚Üí ${t.to_city}\n` +
            `–í—ã–µ–∑–¥: ${t.departure_time}\n` +
            `–ú–µ—Å—Ç –≤—Å–µ–≥–æ: ${t.seats_total}, —Å–≤–æ–±–æ–¥–Ω–æ: ${t.seats_available}`;
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/driver/active-trip:', err);
          driverActiveInfo.textContent =
            '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏.';
        });
    }

    // –ü–∞—Å—Å–∞–∂–∏—Ä: —Å–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫
    function loadTrips() {
      tripsList.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–µ–∑–¥–æ–∫...';

      fetch('/api/trips')
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            tripsList.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            renderTrips(data.trips || []);
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/trips:', err);
          tripsList.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –ø–æ–µ–∑–¥–æ–∫.';
        });
    }

    function renderTrips(trips) {
      if (!trips || trips.length === 0) {
        tripsList.textContent = '–ü–æ–µ–∑–¥–æ–∫ —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç.';
        return;
      }

      tripsList.innerHTML = '';
      trips.forEach((t) => {
        const div = document.createElement('div');
        div.className = 'trip-card';

        const header = document.createElement('div');
        header.className = 'trip-header';

        const routeSpan = document.createElement('div');
        routeSpan.className = 'trip-route';
        routeSpan.textContent = `${t.from_city} ‚Üí ${t.to_city}`;

        const dateSpan = document.createElement('span');
        dateSpan.className = 'small-text';
        dateSpan.textContent = t.departure_time;

        header.appendChild(routeSpan);
        header.appendChild(dateSpan);

        const meta = document.createElement('div');
        meta.className = 'trip-meta';
        meta.innerHTML =
          `–í–æ–¥–∏—Ç–µ–ª—å: ${formatName(t.first_name, t.last_name, t.username)}<br/>` +
          `–ú–µ—Å—Ç –≤—Å–µ–≥–æ: ${t.seats_total}, —Å–≤–æ–±–æ–¥–Ω–æ: ${t.seats_available}<br/>` +
          `–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ: ${t.price_per_seat} ‚ÇΩ` +
          (t.note ? `<br/>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${t.note}` : '');

        const fieldSeats = document.createElement('div');
        fieldSeats.className = 'field';
        const label = document.createElement('label');
        label.textContent = '–°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
        const input = document.createElement('input');
        input.type = 'number';
        input.min = 1;
        input.max = t.seats_available;
        input.value = 1;
        fieldSeats.appendChild(label);
        fieldSeats.appendChild(input);

        const btnBook = document.createElement('button');
        btnBook.className = 'primary-btn';
        btnBook.textContent = '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
        btnBook.addEventListener('click', () => {
          const seats = Number(input.value || 0);
          if (!currentTelegramUser) {
            alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
            return;
          }
          if (!Number.isFinite(seats) || seats <= 0) {
            alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç.');
            return;
          }
          if (seats > t.seats_available) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç.');
            return;
          }
          createBooking(t.id, seats);
        });

        div.appendChild(header);
        div.appendChild(meta);
        div.appendChild(fieldSeats);
        div.appendChild(btnBook);

        tripsList.appendChild(div);
      });
    }

    function createBooking(tripId, seats) {
      fetch('/api/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          trip_id: tripId,
          seats,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
          } else {
            alert('–ë—Ä–æ–Ω—å —Å–æ–∑–¥–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª "–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è".');
            loadTrips();
            loadPassengerActiveBookings();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/bookings:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏.');
        });
    }

    // –ü–∞—Å—Å–∞–∂–∏—Ä: –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏
    btnLoadPassengerActive.addEventListener('click', loadPassengerActiveBookings);

    function loadPassengerActiveBookings() {
      if (!currentTelegramUser) {
        passengerActiveList.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      passengerActiveList.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π...';

      fetch(
        `/api/passenger/active-bookings?telegram_id=${encodeURIComponent(
          String(currentTelegramUser.id)
        )}`
      )
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            passengerActiveList.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            renderPassengerActiveBookings(data.bookings || []);
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/passenger/active-bookings:', err);
          passengerActiveList.textContent =
            '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.';
        });
    }

    function renderPassengerActiveBookings(bookings) {
      const activeBookings = (bookings || []).filter((b) =>
        isStillActiveByDeparture(b.departure_time)
      );

      if (!activeBookings || activeBookings.length === 0) {
        passengerActiveList.textContent = '–ê–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–π—á–∞—Å –Ω–µ—Ç.';
        return;
      }

      passengerActiveList.innerHTML = '';

      activeBookings.forEach((b) => {
        const div = document.createElement('div');
        div.className = 'booking-card';

        const header = document.createElement('div');
        header.className = 'booking-header';

        const routeSpan = document.createElement('div');
        routeSpan.textContent = `${b.from_city} ‚Üí ${b.to_city}`;

        const statusSpan = document.createElement('span');
        statusSpan.className = 'booking-status';
        statusSpan.textContent = '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ';

        header.appendChild(routeSpan);
        header.appendChild(statusSpan);

        const meta = document.createElement('div');
        meta.className = 'booking-meta';

        const driverName = formatName(
          b.driver_first_name,
          b.driver_last_name,
          b.driver_username
        );

        meta.innerHTML =
          `–í–æ–¥–∏—Ç–µ–ª—å: ${driverName}<br/>` +
          `–í—ã–µ–∑–¥: ${b.departure_time}<br/>` +
          `–ú–µ—Å—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${b.seats_booked}`;

        const btnCancel = document.createElement('button');
        btnCancel.className = 'danger-btn';
        btnCancel.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å';
        btnCancel.addEventListener('click', () => {
          cancelPassengerBooking(b.id);
        });

        div.appendChild(header);
        div.appendChild(meta);
        div.appendChild(btnCancel);

        passengerActiveList.appendChild(div);
      });
    }

    function cancelPassengerBooking(bookingId) {
      if (!currentTelegramUser) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
        return;
      }

      if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –±—Ä–æ–Ω—å?')) return;

      fetch('/api/bookings/cancel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          booking_id: bookingId,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
          } else {
            alert('–ë—Ä–æ–Ω—å –æ—Ç–º–µ–Ω–µ–Ω–∞.');
            loadPassengerActiveBookings();
            loadTrips();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –±—Ä–æ–Ω–∏:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –±—Ä–æ–Ω–∏.');
        });
    }

    // –ü–∞—Å—Å–∞–∂–∏—Ä: –ø–ª–∞–Ω—ã –ø–æ–µ–∑–¥–æ–∫
    if (btnCreatePassengerPlan) {
      btnCreatePassengerPlan.addEventListener('click', () => {
        if (!currentTelegramUser) {
          passengerPlanMessage.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
          return;
        }

        const fromCity = planFromCityInput.value.trim();
        const toCity = planToCityInput.value.trim();
        const desiredTime = planDesiredTimeInput.value;
        const seatsNeeded = planSeatsNeededInput.value;
        const note = planNoteInput.value.trim();

        if (!fromCity || !toCity || !desiredTime || !seatsNeeded) {
          passengerPlanMessage.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.';
          return;
        }

        passengerPlanMessage.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ–µ–∑–¥–∫–∏...';

        fetch('/api/passenger/plans', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegram_id: String(currentTelegramUser.id),
            from_city: fromCity,
            to_city: toCity,
            desired_time: desiredTime,
            seats_needed: seatsNeeded,
            note,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              passengerPlanMessage.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
            } else {
              passengerPlanMessage.textContent =
                '–ü–ª–∞–Ω –ø–æ–µ–∑–¥–∫–∏ —Å–æ–∑–¥–∞–Ω. –í–æ–¥–∏—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç –µ–≥–æ –≤ —Å–≤–æ—ë–º —Å–ø–∏—Å–∫–µ.';
              planFromCityInput.value = '';
              planToCityInput.value = '';
              planDesiredTimeInput.value = '';
              planSeatsNeededInput.value = '1';
              planNoteInput.value = '';
              loadPassengerPlans();
            }
          })
          .catch((err) => {
            console.error('–û—à–∏–±–∫–∞ /api/passenger/plans (POST):', err);
            passengerPlanMessage.textContent = '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.';
          });
      });
    }

    function loadPassengerPlans() {
      if (!currentTelegramUser) {
        passengerPlansList.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      passengerPlansList.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫...';

      fetch(
        `/api/passenger/plans?telegram_id=${encodeURIComponent(
          String(currentTelegramUser.id)
        )}`
      )
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            passengerPlansList.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            renderPassengerPlans(data.plans || []);
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/passenger/plans (GET):', err);
          passengerPlansList.textContent =
            '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫.';
        });
    }

        function renderPassengerPlans(plans) {
      // —Å–∫—Ä—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 20 –º–∏–Ω—É—Ç –æ—Ç –∂–µ–ª–∞–µ–º–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–µ–∑–¥–∞
      const filtered = (plans || []).filter((p) => {
        if (p.status !== 'active') {
          // –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ (taken/cancelled/expired) –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
          return true;
        }
        return isPlanStillActive(p.desired_time);
      });

      if (!filtered || filtered.length === 0) {
        passengerPlansList.textContent = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫.';
        return;
      }

      passengerPlansList.innerHTML = '';
      filtered.forEach((p) => {
        const div = document.createElement('div');
        div.className = 'plan-card';

        const header = document.createElement('div');
        header.className = 'trip-header';

        const routeSpan = document.createElement('div');
        routeSpan.className = 'trip-route';
        routeSpan.textContent = `${p.from_city} ‚Üí ${p.to_city}`;

        const timeSpan = document.createElement('span');
        timeSpan.className = 'small-text';
        timeSpan.textContent = formatDateReadable(p.desired_time);

        header.appendChild(routeSpan);
        header.appendChild(timeSpan);

        const meta = document.createElement('div');
        meta.className = 'trip-meta';

        let statusText = '';
        if (p.status === 'active') statusText = '–ê–∫—Ç–∏–≤–µ–Ω';
        else if (p.status === 'taken') statusText = '–í–∞—Å –∑–∞–±–µ—Ä—ë—Ç –≤–æ–¥–∏—Ç–µ–ª—å';
        else if (p.status === 'cancelled') statusText = '–û—Ç–º–µ–Ω—ë–Ω';
        else if (p.status === 'expired') statusText = '–ò—Å—Ç—ë–∫';
        else statusText = p.status || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

        let driverInfo = '';
        if (p.status === 'taken' && p.driver_username) {
          driverInfo =
            '<br/>–í–æ–¥–∏—Ç–µ–ª—å: ' +
            formatName(p.driver_first_name, p.driver_last_name, p.driver_username);
        }

        meta.innerHTML =
          `–ù—É–∂–Ω–æ –º–µ—Å—Ç: ${p.seats_needed}` +
          (p.note ? `<br/>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${p.note}` : '') +
          `<br/>–í—Ä–µ–º—è –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–≥–æ –≤—ã–µ–∑–¥–∞: ${formatDateReadable(p.desired_time)}` +
          `<br/><span class="tag">–°—Ç–∞—Ç—É—Å: ${statusText}</span>` +
          driverInfo;

        div.appendChild(header);
        div.appendChild(meta);

        if (p.status === 'active') {
          const btnCancel = document.createElement('button');
          btnCancel.className = 'danger-btn';
          btnCancel.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å –ø–ª–∞–Ω';
          btnCancel.addEventListener('click', () => {
            cancelPassengerPlan(p.id);
          });
          div.appendChild(btnCancel);
        }

        passengerPlansList.appendChild(div);
      });
    }

    function cancelPassengerPlan(planId) {
      if (!currentTelegramUser) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
        return;
      }
      if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–µ–∑–¥–∫—É?')) return;

      fetch('/api/passenger/plans/cancel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          plan_id: planId,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
          } else {
            alert('–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.');
            loadPassengerPlans();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/passenger/plans/cancel:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏.');
        });
    }

    // –í–æ–¥–∏—Ç–µ–ª—å: –ø–ª–∞–Ω—ã –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ (UI)
    if (driverPassengerPlansHeader) {
      driverPassengerPlansHeader.addEventListener('click', () => {
        const isHidden = driverPassengerPlansContent.classList.contains('hidden');
        if (isHidden) {
          driverPassengerPlansContent.classList.remove('hidden');
          driverPassengerPlansArrow.classList.add('rotated');
          loadDriverPassengerPlans();
        } else {
          driverPassengerPlansContent.classList.add('hidden');
          driverPassengerPlansArrow.classList.remove('rotated');
        }
      });
    }

    if (btnReloadDriverPassengerPlans) {
      btnReloadDriverPassengerPlans.addEventListener('click', () => {
        loadDriverPassengerPlans();
      });
    }

    function loadDriverPassengerPlans() {
      if (!currentTelegramUser) {
        driverPassengerPlansList.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      driverPassengerPlansList.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤...';

      fetch(
        `/api/driver/passenger-plans?telegram_id=${encodeURIComponent(
          String(currentTelegramUser.id)
        )}`
      )
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverPassengerPlansList.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            renderDriverPassengerPlans(data.plans || []);
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/driver/passenger-plans:', err);
          driverPassengerPlansList.textContent =
            '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤.';
        });
    }

        function renderDriverPassengerPlans(plans) {
      // –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–¥–æ +20 –º–∏–Ω—É—Ç –æ—Ç –∂–µ–ª–∞–µ–º–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
      const activePlans = (plans || []).filter((p) => isPlanStillActive(p.desired_time));

      if (!activePlans || activePlans.length === 0) {
        driverPassengerPlansList.textContent = '–ó–∞–ø—Ä–æ—Å–æ–≤ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ —Å–µ–π—á–∞—Å –Ω–µ—Ç.';
        return;
      }

      driverPassengerPlansList.innerHTML = '';

      activePlans.forEach((p) => {
        const div = document.createElement('div');
        div.className = 'plan-card';

        const header = document.createElement('div');
        header.className = 'trip-header';

        const routeSpan = document.createElement('div');
        routeSpan.className = 'trip-route';
        routeSpan.textContent = `${p.from_city} ‚Üí ${p.to_city}`;

        const timeSpan = document.createElement('span');
        timeSpan.className = 'small-text';
        timeSpan.textContent = formatDateReadable(p.desired_time);

        header.appendChild(routeSpan);
        header.appendChild(timeSpan);

        const meta = document.createElement('div');
        meta.className = 'trip-meta';

        const passengerName = formatName(
          p.passenger_first_name,
          p.passenger_last_name,
          p.passenger_username
        );

        meta.innerHTML =
          `–ü–∞—Å—Å–∞–∂–∏—Ä: ${passengerName}<br/>` +
          `–ù—É–∂–Ω–æ –º–µ—Å—Ç: ${p.seats_needed}<br/>` +
          `–ù–µ—è–≤–æ–∫ —É –ø–∞—Å—Å–∞–∂–∏—Ä–∞: ${p.passenger_no_show_count || 0}` +
          (p.note ? `<br/>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${p.note}` : '') +
          `<br/>–í—Ä–µ–º—è –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–≥–æ –≤—ã–µ–∑–¥–∞: ${formatDateReadable(p.desired_time)}`;

        const btnTake = document.createElement('button');
        btnTake.className = 'primary-btn';
        btnTake.textContent = '–ó–∞–±—Ä–∞—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞';
        btnTake.addEventListener('click', () => {
          takePassengerPlan(p.id);
        });

        div.appendChild(header);
        div.appendChild(meta);
        div.appendChild(btnTake);

        driverPassengerPlansList.appendChild(div);
      });
    }

    function takePassengerPlan(planId) {
      if (!currentTelegramUser) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
        return;
      }

      if (
        !confirm(
          '–í—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–∞—Ç—å —ç—Ç–æ–≥–æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞? –ï–º—É –ø—Ä–∏–¥—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–í–∞—Å –∑–∞–±–µ—Ä—ë—Ç –≤–æ–¥–∏—Ç–µ–ª—å¬ª.'
        )
      ) {
        return;
      }

      fetch('/api/driver/passenger-plans/take', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          plan_id: planId,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
          } else {
            alert('–í—ã –≤–∑—è–ª–∏ —ç—Ç—É –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–µ–∑–¥–∫—É. –ü–∞—Å—Å–∞–∂–∏—Ä—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.');
            loadDriverPassengerPlans();
            loadPassengerPlans();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/driver/passenger-plans/take:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏.');
        });
    }

    // –í–æ–¥–∏—Ç–µ–ª—å: –±–ª–æ–∫ –æ–ø–ª–∞—Ç—ã
    function loadDriverPaymentInfo() {
      if (!currentTelegramUser) {
        driverPaymentBlock.classList.add('hidden');
        return;
      }

      fetch(
        `/api/driver/daily-stats?telegram_id=${encodeURIComponent(
          String(currentTelegramUser.id)
        )}`
      )
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverPaymentBlock.classList.add('hidden');
            return;
          }

          const settings = data.settings || {};
          const stats = data.stats || {};
          const hasProof = !!data.has_proof_today;
          const isBlocked = data.is_blocked || 0;

          if (!settings.monetization_enabled) {
            driverPaymentBlock.classList.add('hidden');
          } else {
            driverPaymentBlock.classList.remove('hidden');
          }

          const trips = stats.trips_count || 0;
          const bookings = stats.bookings_count || 0;
          const seats = stats.seats_count || 0;
          const fee = stats.app_fee_total || 0;

          const lines = [];

          lines.push('–°–µ—Ä–≤–∏—Å —Å—Ç–∞–ª –Ω–µ–º–Ω–æ–≥–æ –ø–ª–∞—Ç–Ω—ã–º –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π.');
          lines.push('–ö–æ–º–∏—Å—Å–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å "–ø–æ–ø—É—Ç—á–∏–∫–∏".');
          lines.push('');
          lines.push('–ó–∞ —Å–µ–≥–æ–¥–Ω—è:');
          lines.push(`‚Ä¢ –ü–æ–µ–∑–¥–æ–∫ —Å –±—Ä–æ–Ω—è–º–∏: ${trips}`);
          lines.push(`‚Ä¢ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: ${bookings}`);
          lines.push(`‚Ä¢ –ú–µ—Å—Ç: ${seats}`);
          lines.push(`‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞: ${fee.toFixed(2)} ‚ÇΩ`);

          if (fee > 0 && !hasProof) {
            lines.push('');
            lines.push(
              '–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —á–µ–∫–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–µ–∑–¥–∫–∏.'
            );
          } else if (hasProof) {
            lines.push('');
            lines.push('–ß–µ–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω. –°–ø–∞—Å–∏–±–æ, –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å.');
          } else if (fee === 0) {
            lines.push('');
            lines.push('–°–µ–≥–æ–¥–Ω—è –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–∏—Å—Å–∏–π ‚Äî —á–µ–∫ –º–æ–∂–Ω–æ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å.');
          }

          if (isBlocked) {
            lines.push('');
            lines.push('–í–Ω–∏–º–∞–Ω–∏–µ: –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
            lines.push('–ù–æ–≤—ã–µ –ø–æ–µ–∑–¥–∫–∏ –ø–æ–∫–∞ –Ω–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å.');
          }

          driverPaymentInfo.innerHTML = lines.join('<br/>');

          const details = settings.payment_details || '';
          if (details) {
            driverPaymentRequisites.innerHTML =
              '–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã:<br/>' + details.replace(/\n/g, '<br/>');

            driverPaymentDetailsCopy.value = details;
            driverPaymentCopyBlock.classList.remove('hidden');
          } else {
            driverPaymentRequisites.textContent =
              '–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.';
            driverPaymentDetailsCopy.value = '';
            driverPaymentCopyBlock.classList.add('hidden');
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–Ω–µ–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–æ–¥–∏—Ç–µ–ª—è:', err);
          driverPaymentInfo.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.';
        });
    }

    btnUploadPayment.addEventListener('click', () => {
      if (!currentTelegramUser) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
        return;
      }
      if (!driverPaymentFile.files || !driverPaymentFile.files[0]) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —á–µ–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.');
        return;
      }

      const formData = new FormData();
      formData.append('telegram_id', String(currentTelegramUser.id));
      formData.append('file', driverPaymentFile.files[0]);

      fetch('/api/driver/payment-proof', {
        method: 'POST',
        body: formData,
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
          } else {
            alert('–ß–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω. –°–ø–∞—Å–∏–±–æ!');
            driverPaymentFile.value = '';
            loadDriverPaymentInfo();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ–∫–∞:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.');
        });
    });

    btnCopyPaymentDetails.addEventListener('click', () => {
      const text = driverPaymentDetailsCopy.value || '';
      if (!text) {
        alert('–ù–µ—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.');
        return;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert('–†–µ–∫–≤–∏–∑–∏—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.');
          })
          .catch(() => {
            driverPaymentDetailsCopy.select();
            document.execCommand('copy');
            alert('–†–µ–∫–≤–∏–∑–∏—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã.');
          });
      } else {
        driverPaymentDetailsCopy.select();
        document.execCommand('copy');
        alert('–†–µ–∫–≤–∏–∑–∏—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã.');
      }
    });

    // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    function loadAdminSettings() {
      if (!currentTelegramUser || String(currentTelegramUser.id) !== String(ADMIN_ID)) {
        return;
      }

      adminSettingsInfo.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...';

      fetch(
        `/api/admin/settings?telegram_id=${encodeURIComponent(
          String(currentTelegramUser.id)
        )}`
      )
        .then((res) => res.json().then((data) => ({ ok: res.ok, data })))
        .then(({ ok, data }) => {
          if (!ok || data.error) {
            adminSettingsInfo.textContent = '–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
            return;
          }

          const s = data.settings || {};
          const enabled = !!s.monetization_enabled;
          adminSettingsInfo.textContent =
            '–ü–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π —Å–µ–π—á–∞—Å: ' + (enabled ? '–í–ö–õ–Æ–ß–ï–ù' : '–í–´–ö–õ–Æ–ß–ï–ù');
          adminPaymentDetails.value = s.payment_details || '';
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/admin/settings (GET):', err);
          adminSettingsInfo.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫.';
        });
    }

    btnEnablePay.addEventListener('click', () => {
      if (!currentTelegramUser || String(currentTelegramUser.id) !== String(ADMIN_ID)) return;

      fetch('/api/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          monetization_enabled: true,
          payment_details: adminPaymentDetails.value || '',
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            adminSettingsInfo.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            adminSettingsInfo.textContent = '–ü–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω.';
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/admin/settings (POST enable):', err);
          adminSettingsInfo.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫.';
        });
    });

    btnDisablePay.addEventListener('click', () => {
      if (!currentTelegramUser || String(currentTelegramUser.id) !== String(ADMIN_ID)) return;

      fetch('/api/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          monetization_enabled: false,
          payment_details: adminPaymentDetails.value || '',
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            adminSettingsInfo.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            adminSettingsInfo.textContent = '–ü–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω.';
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/admin/settings (POST disable):', err);
          adminSettingsInfo.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫.';
        });
    });

    btnLoadStats.addEventListener('click', () => {
      if (!currentTelegramUser || String(currentTelegramUser.id) !== String(ADMIN_ID)) {
        adminStatsInfo.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.';
        return;
      }

      adminStatsInfo.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...';

      fetch(
        `/api/admin/stats?telegram_id=${encodeURIComponent(
          String(currentTelegramUser.id)
        )}`
      )
        .then((res) => res.json().then((data) => ({ ok: res.ok, data })))
        .then(({ ok, data }) => {
          if (!ok || data.error) {
            adminStatsInfo.textContent = '–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
            return;
          }

          const s = data.stats || {};
          const trips = s.trips_count || 0;
          const bookings = s.bookings_count || 0;
          const seats = s.seats_booked_total || 0;
          const total = s.total_turnover || 0;
          const fee = s.total_app_fee || 0;
          const driverAmount = s.total_driver_amount || 0;

          adminStatsInfo.innerHTML =
            `–ü–æ–µ–∑–¥–æ–∫ —Å –±—Ä–æ–Ω—è–º–∏: ${trips}<br/>` +
            `–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: ${bookings}<br/>` +
            `–ú–µ—Å—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${seats}<br/>` +
            `–û–±–æ—Ä–æ—Ç: ${total.toFixed(2)} ‚ÇΩ<br/>` +
            `–ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞: ${fee.toFixed(2)} ‚ÇΩ<br/>` +
            `–°—É–º–º–∞ –≤–æ–¥–∏—Ç–µ–ª—è–º: ${driverAmount.toFixed(2)} ‚ÇΩ`;
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/admin/stats:', err);
          adminStatsInfo.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.';
        });
    });

    btnLoadDailyDrivers.addEventListener('click', () => {
      if (!currentTelegramUser || String(currentTelegramUser.id) !== String(ADMIN_ID)) {
        adminDailyDrivers.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.';
        return;
      }

      adminDailyDrivers.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π...';

      const dateVal = adminDriversDate.value;

      let url = `/api/admin/daily-drivers?telegram_id=${encodeURIComponent(
        String(currentTelegramUser.id)
      )}`;
      if (dateVal) {
        url += `&date=${encodeURIComponent(dateVal)}`;
      }

      fetch(url)
        .then((res) => res.json().then((data) => ({ ok: res.ok, data })))
        .then(({ ok, data }) => {
          if (!ok || data.error) {
            adminDailyDrivers.textContent = '–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
            return;
          }

          const list = data.drivers || [];
          if (!list.length) {
            adminDailyDrivers.textContent =
              '–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–µ–∑–¥–æ–∫ —Å –±—Ä–æ–Ω—è–º–∏.';
            return;
          }

          let html = '';
          list.forEach((d) => {
            const name =
              `${d.first_name || ''} ${d.last_name || ''}`.trim() || '–±–µ–∑ –∏–º–µ–Ω–∏';
            const username = d.username ? `@${d.username}` : '';
            const fee = d.app_fee_total || 0;
            const statusText = d.is_blocked ? '–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù' : '–ê–∫—Ç–∏–≤–µ–Ω';

            let proofText = '—á–µ–∫ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–ª—Å—è';
            if (d.last_proof_file) {
              const urlFile = `/uploads/${encodeURIComponent(d.last_proof_file)}`;
              proofText = `–ø–æ—Å–ª–µ–¥–Ω–∏–π —á–µ–∫: <a href="${urlFile}" target="_blank">${
                d.last_proof_original_name || '—Ñ–∞–π–ª'
              }</a>`;
            }

            const btnLabel = d.is_blocked ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
            const action = d.is_blocked ? 'unblock' : 'block';

            html +=
              `<div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #e5e7eb;">` +
              `<strong>${name}</strong> ${username}<br/>` +
              `–ü–æ–µ–∑–¥–æ–∫ —Å –±—Ä–æ–Ω—è–º–∏: ${d.trips_count || 0}, –±—Ä–æ–Ω–µ–π: ${
                d.bookings_count || 0
              }, –º–µ—Å—Ç: ${d.seats_count || 0}<br/>` +
              `–ö–æ–º–∏—Å—Å–∏—è –∑–∞ –¥–µ–Ω—å: ${fee.toFixed(2)} ‚ÇΩ<br/>` +
              `–°—Ç–∞—Ç—É—Å: ${statusText}<br/>` +
              `${proofText}<br/>` +
              `<button class="danger-btn admin-block-btn" data-driver-tg="${
                d.telegram_id
              }" data-action="${action}">${btnLabel}</button>` +
              `</div>`;
          });

          adminDailyDrivers.innerHTML = html;
          initAdminDriverBlockButtons();
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ /api/admin/daily-drivers:', err);
          adminDailyDrivers.textContent =
            '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π.';
        });
    });

    function initAdminDriverBlockButtons() {
      const buttons = document.querySelectorAll('.admin-block-btn');
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const driverTg = btn.getAttribute('data-driver-tg');
          const action = btn.getAttribute('data-action');
          if (!driverTg || !action) return;

          const block = action === 'block';
          const confirmText = block
            ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è? –û–Ω –Ω–µ —Å–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–µ–∑–¥–∫–∏.'
            : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è?';

          if (!confirm(confirmText)) return;

          fetch('/api/admin/block-driver', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              telegram_id: String(currentTelegramUser.id),
              driver_telegram_id: driverTg,
              block,
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.error) {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
              } else {
                alert('–°—Ç–∞—Ç—É—Å –≤–æ–¥–∏—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—ë–Ω.');
                btnLoadDailyDrivers.click();
              }
            })
            .catch((err) => {
              console.error('–û—à–∏–±–∫–∞ /api/admin/block-driver:', err);
              alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤–æ–¥–∏—Ç–µ–ª—è.');
            });
        });
      });
    }
  </script>
</body>
</html>
