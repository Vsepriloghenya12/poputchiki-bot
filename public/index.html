<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ø–æ–ø—É—Ç—á–∏–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e5e7eb;
      color: #111827;
    }
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px 12px 60px 12px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 14px 14px 16px 14px;
      margin-bottom: 14px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
      border: 1px solid #e5e7eb;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .logo {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f704db, #10b981);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #374151;
      margin-bottom: 8px;
    }

    .info {
      font-size: 13px;
      color: #4b5563;
      margin-top: 4px;
      white-space: pre-line;
      line-height: 1.4;
    }
    .small-text {
      font-size: 11px;
      color: #6b7280;
    }

    .field {
      margin-bottom: 8px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 3px;
    }
    .field input,
    .field textarea,
    .field select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 7px 9px;
      font-size: 15px;
      box-sizing: border-box;
      background: #f9fafb;
    }
    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
      background: #ffffff;
    }
    .field-inline {
      display: flex;
      gap: 8px;
    }
    .field-inline .field {
      flex: 1;
      margin-bottom: 0;
    }

    .role-buttons {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    .role-buttons button {
      flex: 1;
      border-radius: 16px;
      padding: 12px 0;
      font-size: 15px;
      font-weight: 700;
      color: #ffffff;
      border: none;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.15s ease;
    }

    #btn-driver {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.4);
    }
    #btn-driver:hover {
      background: linear-gradient(135deg, #1e40af, #1d4ed8);
    }

    #btn-passenger {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 3px 8px rgba(16, 185, 129, 0.4);
    }
    #btn-passenger:hover {
      background: linear-gradient(135deg, #047857, #059669);
    }

    .role-buttons button:active {
      transform: scale(0.97);
      box-shadow: none;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .primary-btn {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
    }
    .primary-btn:hover:not(:disabled) {
      background: #1d4ed8;
    }
    .secondary-btn {
      background: #e5e7eb;
      color: #111827;
    }
    .secondary-btn:hover:not(:disabled) {
      background: #d1d5db;
    }
    .danger-btn {
      background: #ef4444;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.35);
    }
    .danger-btn:hover:not(:disabled) {
      background: #dc2626;
    }

    .trip-card,
    .booking-card,
    .plan-card {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 8px 9px;
      margin-bottom: 8px;
      font-size: 13px;
      background: #f9fafb;
    }

    .trip-header,
    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 6px;
    }
    .trip-route,
    .booking-status {
      font-weight: 700;
      font-size: 14px;
    }
    .booking-status {
      color: #059669;
      white-space: nowrap;
    }
    .trip-meta,
    .booking-meta {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.4;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: #eef2ff;
      color: #3730a3;
      margin-right: 4px;
      margin-top: 2px;
    }

    .hidden {
      display: none !important;
    }

    /* –°–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã */
    #driver-section,
    #driver-active,
    #driver-history,
    #driver-passenger-plans,
    #driver-payment-block {
      border-left: 4px solid #2563eb;
      padding-left: 12px;
    }

    #passenger-section,
    #passenger-active,
    #passenger-plans-section {
      border-left: 4px solid #10b981;
      padding-left: 12px;
    }

    #admin-section {
      border-left: 4px solid #f97316;
      padding-left: 12px;
    }

    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 10px;
      background: #f3f4f6;
      margin-top: 4px;
    }
    .collapsible-header span {
      font-weight: 600;
      font-size: 14px;
    }
    .arrow {
      font-size: 16px;
      transition: transform 0.15s ease;
    }
    .arrow.rotated {
      transform: rotate(90deg);
    }
    .card-collapsible-content {
      margin-top: 8px;
    }
    .card-collapsed .card-collapsible-content {
      display: none;
    }

    /* Tabs */
    .tabs-bar {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.10);
      margin-bottom: 12px;
      position: sticky;
      top: 8px;
      z-index: 50;
    }
    .tab-btn {
      flex: 1;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      border-radius: 14px;
      padding: 10px 8px;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #111827;
      color: #ffffff;
      border-color: #111827;
    }

    /* Filters */
    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 10px 0 10px 0;
      padding: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
    }
    .filters .field { margin-bottom: 0; }
    .filters .field label { font-size: 11px; font-weight: 800; color: #374151; }
    .filters .actions { grid-column: 1 / -1; display: flex; gap: 8px; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      border: 1px solid #e5e7eb;
      background: #fff;
      margin-left: 6px;
    }
    .badge.soon { background: #ecfeff; border-color: #06b6d4; }
    .badge.now  { background: #ecfdf5; border-color: #10b981; }
    .badge.late { background: #fff1f2; border-color: #ef4444; }

    .error-text {
      font-size: 12px;
      color: #dc2626;
      margin-top: 6px;
      font-weight: 800;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –®–∞–ø–∫–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º -->
    <div class="card">
      <div class="title-row">
        <div class="logo">üöó</div>
        <div class="title">–ø–æ–ø—É—Ç—á–∏–∫–∏</div>
      </div>
      <div class="info" id="user-info">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...
      </div>
    </div>

    <!-- –í—ã–±–æ—Ä —Ä–æ–ª–∏ -->
    <div class="card">
      <div class="subtitle">–ö—Ç–æ –≤—ã?</div>
      <div class="role-buttons">
        <button class="secondary-btn" id="btn-driver">–Ø –≤–æ–¥–∏—Ç–µ–ª—å</button>
        <button class="secondary-btn" id="btn-passenger">–Ø –ø–∞—Å—Å–∞–∂–∏—Ä</button>
      </div>
      <div class="info" id="role-info">
        –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.
      </div>
    </div>

    <!-- Tabs: Driver -->
    <div class="tabs-bar hidden" id="driver-tabs-bar">
      <button class="tab-btn active" data-role="driver" data-tab="create">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="tab-btn" data-role="driver" data-tab="active">–ê–∫—Ç–∏–≤–Ω–∞—è</button>
      <button class="tab-btn" data-role="driver" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="tab-btn" data-role="driver" data-tab="plans">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button>
    </div>

    <!-- Tabs: Passenger -->
    <div class="tabs-bar hidden" id="passenger-tabs-bar">
      <button class="tab-btn active" data-role="passenger" data-tab="trips">–ü–æ–µ–∑–¥–∫–∏</button>
      <button class="tab-btn" data-role="passenger" data-tab="bookings">–ú–æ–∏ –±—Ä–æ–Ω–∏</button>
      <button class="tab-btn" data-role="passenger" data-tab="plan">–ü–ª–∞–Ω</button>
    </div>

    <!-- –í–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π HTML (–∫–∞—Ä—Ç–æ—á–∫–∏) ‚Äî —Ç–æ—á–Ω–æ –∫–∞–∫ —É —Ç–µ–±—è, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <!-- (driver-section, driver-active, driver-history, driver-passenger-plans, passenger-section, passenger-active, passenger-plans-section, driver-payment-block, admin-section) -->
    <!-- –Ø –Ω–µ –∫–æ–ø–∏—Ä—É—é, —á—Ç–æ–±—ã –Ω–µ —É–¥–ª–∏–Ω—è—Ç—å, –Ω–æ –æ–Ω–∏ 100% –∏–¥–µ–Ω—Ç–∏—á–Ω—ã —Ç–≤–æ–µ–º—É –æ—Ä–∏–≥–∏–Ω–∞–ª—É -->

    <!-- –ü—Ä–∏–º–µ—Ä –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ (—á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å) -->
    <div class="card hidden" id="passenger-section" data-collapsible="1" data-title="–ü–∞—Å—Å–∞–∂–∏—Ä: –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏">
      <div class="subtitle">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</div>
      <div class="info small-text">
        –°–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫ —Å –µ—â—ë —Å–≤–æ–±–æ–¥–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏ –∏ —Å –≤—ã–µ–∑–¥–æ–º –Ω–µ —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥.
      </div>
      <div class="filters" id="passenger-filters">
        <div class="field">
          <label>–û—Ç–∫—É–¥–∞</label>
          <select id="filter-from">
            <option value="">–õ—é–±–æ–π</option>
          </select>
        </div>
        <div class="field">
          <label>–ö—É–¥–∞</label>
          <select id="filter-to">
            <option value="">–õ—é–±–æ–π</option>
          </select>
        </div>
        <div class="field">
          <label>–î–∞—Ç–∞</label>
          <select id="filter-day">
            <option value="any">–õ—é–±–∞—è</option>
            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="tomorrow">–ó–∞–≤—Ç—Ä–∞</option>
          </select>
        </div>
        <div class="field">
          <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <select id="filter-sort">
            <option value="time_asc">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Üë</option>
            <option value="time_desc">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Üì</option>
          </select>
        </div>
        <div class="actions">
          <button class="secondary-btn" id="btn-apply-filters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button class="secondary-btn" id="btn-reset-filters">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <button class="secondary-btn" id="btn-refresh-trips">–û–±–Ω–æ–≤–∏—Ç—å</button>

      <div id="trips-list" class="info">
        –ü–æ–µ–∑–¥–∫–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–∫ –≤ —Ç–≤–æ—ë–º –æ—Ä–∏–≥–∏–Ω–∞–ª–µ -->
  </div>
    <script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    const ADMIN_ID = 504348666;

    let currentTelegramUser = null;
    let activeTripId = null;

    // –ì–æ—Ä–æ–¥–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const CITIES = ["", "–°–æ—á–∏", "–ê–¥–ª–µ—Ä", "–ê—ç—Ä–æ–ø–æ—Ä—Ç –°–æ—á–∏", "–ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞", "–†–æ–∑–∞ –•—É—Ç–æ—Ä", "–†–æ–∑–∞ –ü–ª–∞—Ç–æ", "–ì–∞–∑–ø—Ä–æ–º", "–≠—Å—Ç–æ-–°–∞–¥–æ–∫"];

    const userInfoDiv = document.getElementById('user-info');

    // –§–∏–∫—Å –¥–ª—è Telegram Desktop
    if (tg && (!tg.initDataUnsafe || !tg.initDataUnsafe.user)) {
      const hash = window.location.hash.substring(1);
      if (hash.startsWith('tgWebAppData=')) {
        const params = new URLSearchParams(hash);
        const dataStr = params.get('tgWebAppData');
        if (dataStr) {
          const dataParams = new URLSearchParams(dataStr);
          const userJson = dataParams.get('user');
          if (userJson) {
            try {
              tg.initDataUnsafe = tg.initDataUnsafe || {};
              tg.initDataUnsafe.user = JSON.parse(decodeURIComponent(userJson));
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ user –∏–∑ hash:', e);
            }
          }
        }
      }
    }

    // –¢–≤–æ—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      tg.expand();
      currentTelegramUser = tg.initDataUnsafe.user;

      userInfoDiv.textContent =
        `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${currentTelegramUser.first_name || ''} ${currentTelegramUser.last_name || ''} (@${currentTelegramUser.username || '–±–µ–∑ username'})`;

      fetch('/api/init-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: currentTelegramUser }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) console.error('–û—à–∏–±–∫–∞ init-user:', data.error);
          if (currentTelegramUser && String(currentTelegramUser.id) === String(ADMIN_ID)) {
            document.getElementById('admin-section').classList.remove('hidden');
            loadAdminSettings();
          }
        })
        .catch((err) => console.error('–û—à–∏–±–∫–∞ init-user:', err));
    } else {
      userInfoDiv.textContent = '–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.';
    }

    // –§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–Ω–æ–ø–æ–∫
    function setButtonLoading(btn, loading) {
      btn.disabled = loading;
      if (loading) {
        btn.dataset.originalText = btn.textContent;
        btn.textContent = '‚è≥';
      } else if (btn.dataset.originalText) {
        btn.textContent = btn.dataset.originalText;
        delete btn.dataset.originalText;
      }
    }

    // –§–∏–ª—å—Ç—Ä—ã
    function populateCitySelects() {
      [document.getElementById('filter-from'), document.getElementById('filter-to')].forEach(select => {
        select.innerHTML = '';
        CITIES.forEach(city => {
          const opt = document.createElement('option');
          opt.value = city;
          opt.textContent = city || '–õ—é–±–æ–π';
          select.appendChild(opt);
        });
      });
    }

    let currentFilters = { from: '', to: '', day: 'any', sort: 'time_asc' };

    function applyFilters() {
      currentFilters.from = document.getElementById('filter-from').value;
      currentFilters.to = document.getElementById('filter-to').value;
      currentFilters.day = document.getElementById('filter-day').value;
      currentFilters.sort = document.getElementById('filter-sort').value;
      loadTrips();
    }

    function resetFilters() {
      document.getElementById('filter-from').value = '';
      document.getElementById('filter-to').value = '';
      document.getElementById('filter-day').value = 'any';
      document.getElementById('filter-sort').value = 'time_asc';
      applyFilters();
    }

    document.getElementById('btn-apply-filters').addEventListener('click', applyFilters);
    document.getElementById('btn-reset-filters').addEventListener('click', resetFilters);
    document.getElementById('filter-from').addEventListener('change', applyFilters);
    document.getElementById('filter-to').addEventListener('change', applyFilters);
    document.getElementById('filter-day').addEventListener('change', applyFilters);
    document.getElementById('filter-sort').addEventListener('change', applyFilters);

    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞ (–¥–æ–±–∞–≤—å –≤ –∫–æ–Ω–µ—Ü —Ç–≤–æ–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞)
    // –í —Ç–≤–æ—ë–º –∫–æ–¥–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è:
    planFromCityInput.value = '';
    planToCityInput.value = '';
    planDesiredTimeInput.value = '';
    planSeatsNeededInput.value = '1';
    planNoteInput.value = '';
    passengerPlanMessage.textContent = '–ü–ª–∞–Ω —Å–æ–∑–¥–∞–Ω.';

    // –ó–∞—â–∏—Ç–∞ –∫–Ω–æ–ø–æ–∫ ‚Äî –¥–æ–±–∞–≤—å –≤ –Ω–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ POST-–∫–Ω–æ–ø–æ–∫
    // –ü—Ä–∏–º–µ—Ä –¥–ª—è btn-create-trip:
    document.getElementById('btn-create-trip').addEventListener('click', function() {
      const btn = this;
      if (btn.disabled) return;
      setButtonLoading(btn, true);
      // ... —Ç–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ ...
      // –≤ –∫–æ–Ω—Ü–µ:
      setButtonLoading(btn, false);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initCollapsibleCards();  // –µ—Å–ª–∏ –µ—Å—Ç—å –≤ —Ç–≤–æ—ë–º –∫–æ–¥–µ
    populateCitySelects();

    // –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∏–∑ —Ç–≤–æ–µ–≥–æ <script> ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  </script>
</body>
</html>