<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ü–æ–ø—É—Ç—á–∏–∫–∏ ‚Ä¢ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏ üéÑ</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Manrope', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    #snow-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .app-container {
      position: relative;
      z-index: 2;
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      margin: 20px 0 30px;
    }

    h1 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(90deg, #fbbf24, #f59e0b, #dc2626);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 16px;
      margin-top: 8px;
    }

    .new-year-badge {
      text-align: center;
      font-size: 40px;
      margin: 20px 0;
      animation: sparkle 3s infinite;
    }

    @keyframes sparkle {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }

    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    h2, h3 {
      color: #fbbf24;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
    }

    h2::before, h3::before { content: "üéÑ"; font-size: 24px; }

    input, select, textarea {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
      margin-bottom: 12px;
    }

    input::placeholder, textarea::placeholder { color: #94a3b8; }

    button, .btn {
      padding: 14px 20px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(90deg, #dc2626, #ef4444);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 8px;
    }

    button:hover, .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(220, 38, 38, 0.5);
    }

    .small-btn {
      padding: 10px 16px;
      font-size: 14px;
      width: auto;
      display: inline-block;
      margin: 4px;
    }

    .trip-item, .booking-item, .plan-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 16px;
      border-radius: 16px;
      margin-bottom: 12px;
      border-left: 5px solid #fbbf24;
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
      font-size: 18px;
    }

    .hidden { display: none; }

    .role-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .text-center { text-align: center; }
    .mt-3 { margin-top: 16px; }
  </style>
</head>
<body>
  <canvas id="snow-canvas"></canvas>

  <div class="app-container">
    <div class="new-year-badge">üéÑ‚ùÑÔ∏è‚ú®</div>

    <div class="header">
      <h1>–ü–æ–ø—É—Ç—á–∏–∫–∏</h1>
      <p class="subtitle">–ü–æ–µ–∑–¥–∫–∏ —Å –∫–æ–º—Ñ–æ—Ä—Ç–æ–º ‚Ä¢ –° –ù–æ–≤—ã–º 2026 –≥–æ–¥–æ–º! üéÖ</p>
    </div>

    <div id="app">
      <div id="loading" class="card text-center">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</p>
      </div>

      <div id="main" class="hidden">
        <div class="card">
          <h2>–ü—Ä–∏–≤–µ—Ç, <span id="user-name">-</span>!</h2>
          <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ <span id="user-role">–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span></p>
        </div>

        <!-- –í–æ–¥–∏—Ç–µ–ª—å -->
        <div id="driver-section">
          <!-- –ü—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ -->
          <div class="card">
            <h2>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</h2>
            <div id="car-info">–ù–µ —É–∫–∞–∑–∞–Ω</div>
            <form id="car-form">
              <input type="text" id="car-make" placeholder="–ú–∞—Ä–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Toyota)">
              <input type="text" id="car-color" placeholder="–¶–≤–µ—Ç">
              <input type="text" id="car-plate" placeholder="–ì–æ—Å. –Ω–æ–º–µ—Ä">
              <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤—Ç–æ</button>
            </form>
            <div id="daily-stats" class="mt-3"></div>
            <form id="payment-proof-form" class="mt-3">
              <input type="file" id="proof-file" accept="image/*">
              <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫ –æ–ø–ª–∞—Ç—ã</button>
            </form>
          </div>

          <!-- –°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É -->
          <div class="card">
            <h2>–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</h2>
            <form id="trip-form">
              <input type="text" id="from-city" placeholder="–û—Ç–∫—É–¥–∞" required>
              <input type="text" id="to-city" placeholder="–ö—É–¥–∞" required>
              <input type="datetime-local" id="departure-time" required>
              <input type="number" id="seats-total" placeholder="–í—Å–µ–≥–æ –º–µ—Å—Ç" min="1" required>
              <input type="number" id="price-per-seat" placeholder="–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ (—Ä—É–±)" min="0" required>
              <textarea id="trip-note" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"></textarea>
              <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
            </form>
          </div>

          <!-- –ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏ -->
          <div class="card">
            <h2>–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</h2>
            <div id="my-trips-list"></div>
          </div>

          <!-- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –º–æ–∏—Ö –ø–æ–µ–∑–¥–∫–∞—Ö -->
          <div class="card">
            <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div id="my-bookings-list"></div>
          </div>

          <!-- –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Å—Å–∞–∂–∏—Ä—ã -->
          <div class="card">
            <h2>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Å—Å–∞–∂–∏—Ä—ã</h2>
            <div id="passenger-plans-list"></div>
          </div>
        </div>

        <!-- –ü–∞—Å—Å–∞–∂–∏—Ä -->
        <div id="passenger-section" class="hidden">
          <div class="card">
            <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</h2>
            <form id="search-form">
              <input type="text" id="search-from" placeholder="–û—Ç–∫—É–¥–∞">
              <input type="text" id="search-to" placeholder="–ö—É–¥–∞">
              <button type="submit">–ü–æ–∏—Å–∫</button>
            </form>
            <div id="trips-list"></div>
          </div>

          <div class="card">
            <h2>–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div id="passenger-bookings-list"></div>
          </div>

          <div class="card">
            <h2>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</h2>
            <form id="plan-form">
              <input type="text" id="plan-from" placeholder="–û—Ç–∫—É–¥–∞" required>
              <input type="text" id="plan-to" placeholder="–ö—É–¥–∞" required>
              <input type="text" id="plan-time" placeholder="–ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É—Ç—Ä–æ–º)" required>
              <input type="number" id="plan-seats" placeholder="–°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –Ω—É–∂–Ω–æ" min="1" required>
              <textarea id="plan-note" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"></textarea>
              <button type="submit">–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω</button>
            </form>
          </div>
        </div>

        <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
        <div id="admin-section" class="hidden">
          <div class="card">
            <h2>–ê–¥–º–∏–Ω–∫–∞</h2>
            <div id="admin-stats"></div>
            <h3>–í–æ–¥–∏—Ç–µ–ª–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
            <div id="daily-drivers-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const user = tg.initDataUnsafe.user;
    let currentUser = null;
    let settings = null;

    // –°–Ω–µ–≥
    const canvas = document.getElementById('snow-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });

    const flakes = [];
    for (let i = 0; i < 100; i++) {
      flakes.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 3 + 1,
        speed: Math.random() * 1 + 0.5,
        drift: Math.random() * 0.6 - 0.3,
        opacity: Math.random() * 0.4 + 0.6
      });
    }

    function animateSnow() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      flakes.forEach(f => {
        ctx.fillStyle = `rgba(255,255,255,${f.opacity})`;
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
        ctx.fill();
        f.y += f.speed;
        f.x += f.drift;
        if (f.y > canvas.height) {
          f.y = -10;
          f.x = Math.random() * canvas.width;
        }
      });
      requestAnimationFrame(animateSnow);
    }
    animateSnow();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function initApp() {
      if (!user) {
        document.getElementById('loading').innerHTML = '<p>–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —á–µ—Ä–µ–∑ Telegram</p>';
        return;
      }

      try {
        const res = await fetch('/api/init-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user })
        });
        const data = await res.json();
        currentUser = data.user;
        settings = data.settings;

        document.getElementById('user-name').innerText = currentUser.first_name || currentUser.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main').classList.remove('hidden');

        updateCarInfo();
        loadDailyStats();
        loadMyTrips();
        loadMyBookings();
        loadPassengerPlans();
        loadAvailableTrips();
        loadPassengerBookings();

        if (String(currentUser.telegram_id) === '504348666') {
          document.getElementById('admin-section').classList.remove('hidden');
          loadAdminStats();
          loadDailyDrivers();
        }

      } catch (err) {
        console.error(err);
        document.getElementById('loading').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
      }
    }

    // –ü—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ
    function updateCarInfo() {
      const info = document.getElementById('car-info');
      if (currentUser.car_make || currentUser.car_color || currentUser.car_plate) {
        info.innerText = `${currentUser.car_color || ''} ${currentUser.car_make || ''} ${currentUser.car_plate || ''}`.trim() || '–£–∫–∞–∑–∞–Ω–æ';
      } else {
        info.innerText = '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
      }
    }

    document.getElementById('car-form').addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData();
      formData.append('telegram_id', currentUser.telegram_id);
      formData.append('carMake', document.getElementById('car-make').value);
      formData.append('carColor', document.getElementById('car-color').value);
      formData.append('carPlate', document.getElementById('car-plate').value);

      const res = await fetch('/api/driver/profile', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      currentUser = { ...currentUser, ...data };
      updateCarInfo();
      alert('–ê–≤—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    });

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å
    async function loadDailyStats() {
      const res = await fetch(`/api/driver/stats?telegram_id=${currentUser.telegram_id}`);
      const data = await res.json();
      document.getElementById('daily-stats').innerHTML = `
        –ü–æ–µ–∑–¥–æ–∫: ${data.trips_count}<br>
        –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: ${data.bookings_count}<br>
        –ú–µ—Å—Ç: ${data.seats_count}<br>
        –ó–∞—Ä–∞–±–æ—Ç–æ–∫: ${data.driver_amount_total} ‚ÇΩ
      `;
    }

    // –ß–µ–∫ –æ–ø–ª–∞—Ç—ã
    document.getElementById('payment-proof-form').addEventListener('submit', async e => {
      e.preventDefault();
      const file = document.getElementById('proof-file').files[0];
      if (!file) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ —á–µ–∫–∞');

      const formData = new FormData();
      formData.append('proof', file);
      formData.append('telegram_id', currentUser.telegram_id);

      const res = await fetch('/api/driver/payment-proof', {
        method: 'POST',
        body: formData
      });
      if (res.ok) {
        alert('–ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      } else {
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
      }
    });

    // –°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É
    document.getElementById('trip-form').addEventListener('submit', async e => {
      e.preventDefault();
      const body = {
        telegram_id: currentUser.telegram_id,
        from_city: document.getElementById('from-city').value,
        to_city: document.getElementById('to-city').value,
        departure_time: document.getElementById('departure-time').value,
        seats_total: Number(document.getElementById('seats-total').value),
        price_per_seat: Number(document.getElementById('price-per-seat').value),
        note: document.getElementById('trip-note').value
      };

      const res = await fetch('/api/trips', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (res.ok) {
        alert('–ü–æ–µ–∑–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
        document.getElementById('trip-form').reset();
        loadMyTrips();
      } else {
        const err = await res.json();
        alert(err.error || '–û—à–∏–±–∫–∞');
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–∑–∞–≥–ª—É—à–∫–∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
    async function loadMyTrips() {
      const res = await fetch(`/api/driver/trips?telegram_id=${currentUser.telegram_id}`);
      const trips = await res.json();
      const container = document.getElementById('my-trips-list');
      if (trips.length === 0) {
        container.innerHTML = '<div class="empty">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫</div>';
        return;
      }
      container.innerHTML = trips.map(t => `
        <div class="trip-item">
          <strong>${t.from_city} ‚Üí ${t.to_city}</strong><br>
          ${new Date(t.departure_time).toLocaleString()}<br>
          –ú–µ—Å—Ç: ${t.seats_available}/${t.seats_total} ‚Ä¢ –¶–µ–Ω–∞: ${t.price_per_seat} ‚ÇΩ
        </div>
      `).join('');
    }

    async function loadMyBookings() {
      const res = await fetch(`/api/driver/bookings?telegram_id=${currentUser.telegram_id}`);
      const bookings = await res.json();
      const container = document.getElementById('my-bookings-list');
      if (bookings.length === 0) {
        container.innerHTML = '<div class="empty">–ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>';
        return;
      }
      container.innerHTML = bookings.map(b => `
        <div class="booking-item">
          –ü–∞—Å—Å–∞–∂–∏—Ä: ${b.passenger_name}<br>
          –ú–µ—Å—Ç: ${b.seats_booked} ‚Ä¢ –°—É–º–º–∞: ${b.amount_total} ‚ÇΩ
          <button class="small-btn" onclick="noShow(${b.id})">–ù–µ —è–≤–∏–ª—Å—è</button>
        </div>
      `).join('');
    }

    async function loadPassengerPlans() {
      const res = await fetch(`/api/driver/passenger-plans?telegram_id=${currentUser.telegram_id}`);
      const plans = await res.json();
      const container = document.getElementById('passenger-plans-list');
      if (plans.length === 0) {
        container.innerHTML = '<div class="empty">–ù–µ—Ç –ø–ª–∞–Ω–æ–≤</div>';
        return;
      }
      container.innerHTML = plans.map(p => `
        <div class="plan-item">
          ${p.from_city} ‚Üí ${p.to_city}<br>
          –í—Ä–µ–º—è: ${p.desired_time} ‚Ä¢ –ú–µ—Å—Ç: ${p.seats_needed}
          <button class="small-btn" onclick="takePlan(${p.id})">–í–∑—è—Ç—å</button>
        </div>
      `).join('');
    }

    async function loadAvailableTrips() {
      const res = await fetch('/api/trips/latest');
      const trips = await res.json();
      const container = document.getElementById('trips-list');
      if (trips.length === 0) {
        container.innerHTML = '<div class="empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫</div>';
        return;
      }
      container.innerHTML = trips.map(t => `
        <div class="trip-item">
          <strong>${t.from_city} ‚Üí ${t.to_city}</strong><br>
          ${new Date(t.departure_time).toLocaleString()}<br>
          –í–æ–¥–∏—Ç–µ–ª—å: ${t.driver_name}<br>
          –ú–µ—Å—Ç: ${t.seats_available}/${t.seats_total} ‚Ä¢ ${t.price_per_seat} ‚ÇΩ/–º–µ—Å—Ç–æ
          <button onclick="bookTrip(${t.id})">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      `).join('');
    }

    async function loadPassengerBookings() {
      const res = await fetch(`/api/passenger/bookings?telegram_id=${currentUser.telegram_id}`);
      const bookings = await res.json();
      const container = document.getElementById('passenger-bookings-list');
      if (bookings.length === 0) {
        container.innerHTML = '<div class="empty">–ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>';
        return;
      }
      container.innerHTML = bookings.map(b => `
        <div class="booking-item">
          ${b.from_city} ‚Üí ${b.to_city}<br>
          ${new Date(b.departure_time).toLocaleString()}<br>
          –ú–µ—Å—Ç: ${b.seats_booked}
          <button class="small-btn" onclick="cancelBooking(${b.id})">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
      `).join('');
    }

    // –ê–¥–º–∏–Ω–∫–∞
    async function loadAdminStats() {
      const res = await fetch('/api/admin/stats?telegram_id=504348666');
      const stats = await res.json();
      document.getElementById('admin-stats').innerHTML = `
        –ü–æ–µ–∑–¥–æ–∫: ${stats.trips_count}<br>
        –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: ${stats.bookings_count}<br>
        –í—ã—Ä—É—á–∫–∞: ${stats.total_turnover} ‚ÇΩ<br>
        –ö–æ–º–∏—Å—Å–∏—è: ${stats.total_app_fee} ‚ÇΩ
      `;
    }

    async function loadDailyDrivers() {
      const res = await fetch('/api/admin/daily-drivers?telegram_id=504348666');
      const drivers = await res.json();
      const container = document.getElementById('daily-drivers-list');
      container.innerHTML = drivers.map(d => `
        <div class="trip-item">
          ${d.first_name} ${d.last_name || ''} (@${d.username || 'no'})<br>
          –ü–æ–µ–∑–¥–æ–∫: ${d.trips_count} ‚Ä¢ –ë—Ä–æ–Ω–∏: ${d.bookings_count} ‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è: ${d.app_fee_total} ‚ÇΩ
          ${d.last_proof_file ? '<img src="/uploads/' + d.last_proof_file + '" style="max-width:100%;margin-top:8px;border-radius:8px;">' : '–ß–µ–∫ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'}
          <button class="small-btn" onclick="blockDriver('${d.telegram_id}')">${d.is_blocked ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}</button>
        </div>
      `).join('');
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π
    window.bookTrip = async (tripId) => {
      const seats = prompt('–°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å?');
      if (!seats) return;
      const res = await fetch('/api/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trip_id: tripId, passenger_telegram_id: currentUser.telegram_id, seats_booked: Number(seats) })
      });
      if (res.ok) {
        alert('–ú–µ—Å—Ç–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ!');
        loadAvailableTrips();
        loadPassengerBookings();
      }
    };

    window.takePlan = async (planId) => {
      if (confirm('–í–∑—è—Ç—å —ç—Ç—É –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–µ–∑–¥–∫—É?')) {
        const res = await fetch(`/api/driver/passenger-plans/take`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plan_id: planId, driver_telegram_id: currentUser.telegram_id })
        });
        if (res.ok) {
          alert('–ü–ª–∞–Ω –≤–∑—è—Ç!');
          loadPassengerPlans();
        }
      }
    };

    window.noShow = async (bookingId) => {
      if (confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –Ω–µ—è–≤–∫—É?')) {
        await fetch('/api/driver/bookings/no-show', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ booking_id: bookingId })
        });
        loadMyBookings();
      }
    };

    window.cancelBooking = async (bookingId) => {
      if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) {
        await fetch('/api/passenger/bookings/cancel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ booking_id: bookingId, passenger_telegram_id: currentUser.telegram_id })
        });
        loadPassengerBookings();
      }
    };

    window.blockDriver = async (telegramId) => {
      const block = confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è? (OK = –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å, –û—Ç–º–µ–Ω–∞ = —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å)');
      await fetch('/api/admin/block-driver', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ telegram_id: 504348666, driver_telegram_id: telegramId, block })
      });
      loadDailyDrivers();
    };

    // –ó–∞–ø—É—Å–∫
    initApp();
  </script>
</body>
</html>