<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ø–æ–ø—É—Ç—á–∏–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e5e7eb;
      color: #111827;
    }
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px 12px 60px 12px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 14px 14px 16px 14px;
      margin-bottom: 14px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
      border: 1px solid #e5e7eb;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .logo {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f704db, #10b981);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #374151;
      margin-bottom: 8px;
    }

    .info {
      font-size: 13px;
      color: #4b5563;
      margin-top: 4px;
      white-space: pre-line;
      line-height: 1.4;
    }
    .small-text {
      font-size: 11px;
      color: #6b7280;
    }

    .field {
      margin-bottom: 8px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 3px;
    }
    .field input,
    .field textarea,
    .field select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 7px 9px;
      font-size: 15px;
      box-sizing: border-box;
      background: #f9fafb;
    }
    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
      background: #ffffff;
    }
    .field-inline {
      display: flex;
      gap: 8px;
    }
    .field-inline .field {
      flex: 1;
      margin-bottom: 0;
    }

    .role-buttons {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    .role-buttons button {
      flex: 1;
      border-radius: 16px;
      padding: 12px 0;
      font-size: 15px;
      font-weight: 700;
      color: #ffffff;
      border: none;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.15s ease;
    }

    #btn-driver {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.4);
    }
    #btn-driver:hover {
      background: linear-gradient(135deg, #1e40af, #1d4ed8);
    }

    #btn-passenger {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 3px 8px rgba(16, 185, 129, 0.4);
    }
    #btn-passenger:hover {
      background: linear-gradient(135deg, #047857, #059669);
    }

    .role-buttons button:active {
      transform: scale(0.97);
      box-shadow: none;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .primary-btn {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
    }
    .primary-btn:hover:not(:disabled) {
      background: #1d4ed8;
    }
    .secondary-btn {
      background: #e5e7eb;
      color: #111827;
    }
    .secondary-btn:hover:not(:disabled) {
      background: #d1d5db;
    }
    .danger-btn {
      background: #ef4444;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.35);
    }
    .danger-btn:hover:not(:disabled) {
      background: #dc2626;
    }

    .trip-card,
    .booking-card,
    .plan-card {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 8px 9px;
      margin-bottom: 8px;
      font-size: 13px;
      background: #f9fafb;
    }

    .trip-header,
    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 6px;
    }
    .trip-route,
    .booking-status {
      font-weight: 700;
      font-size: 14px;
    }
    .booking-status {
      color: #059669;
      white-space: nowrap;
    }
    .trip-meta,
    .booking-meta {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.4;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: #eef2ff;
      color: #3730a3;
      margin-right: 4px;
      margin-top: 2px;
    }

    .hidden {
      display: none !important;
    }

    /* –°–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã */
    #driver-section,
    #driver-active,
    #driver-history,
    #driver-passenger-plans,
    #driver-payment-block {
      border-left: 4px solid #2563eb;
      padding-left: 12px;
    }

    #passenger-section,
    #passenger-active,
    #passenger-plans-section {
      border-left: 4px solid #10b981;
      padding-left: 12px;
    }

    #admin-section {
      border-left: 4px solid #f97316;
      padding-left: 12px;
    }

    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 10px;
      background: #f3f4f6;
      margin-top: 4px;
    }
    .collapsible-header span {
      font-weight: 600;
      font-size: 14px;
    }
    .arrow {
      font-size: 16px;
      transition: transform 0.15s ease;
    }
    .arrow.rotated {
      transform: rotate(90deg);
    }
    .card-collapsible-content {
      margin-top: 8px;
    }
    .card-collapsed .card-collapsible-content {
      display: none;
    }

    /* Tabs */
    .tabs-bar {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.10);
      margin-bottom: 12px;
      position: sticky;
      top: 8px;
      z-index: 50;
    }
    .tab-btn {
      flex: 1;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      border-radius: 14px;
      padding: 10px 8px;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #111827;
      color: #ffffff;
      border-color: #111827;
    }

    /* Filters */
    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 10px 0 10px 0;
      padding: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
    }
    .filters .field { margin-bottom: 0; }
    .filters .field label { font-size: 11px; font-weight: 800; color: #374151; }
    .filters .actions { grid-column: 1 / -1; display: flex; gap: 8px; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      border: 1px solid #e5e7eb;
      background: #fff;
      margin-left: 6px;
    }
    .badge.soon { background: #ecfeff; border-color: #06b6d4; }
    .badge.now  { background: #ecfdf5; border-color: #10b981; }
    .badge.late { background: #fff1f2; border-color: #ef4444; }

    .error-text {
      font-size: 12px;
      color: #dc2626;
      margin-top: 6px;
      font-weight: 800;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –®–∞–ø–∫–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º -->
    <div class="card">
      <div class="title-row">
        <div class="logo">üöó</div>
        <div class="title">–ø–æ–ø—É—Ç—á–∏–∫–∏</div>
      </div>
      <div class="info" id="user-info">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...
      </div>
    </div>

    <!-- –í—ã–±–æ—Ä —Ä–æ–ª–∏ -->
    <div class="card">
      <div class="subtitle">–ö—Ç–æ –≤—ã?</div>
      <div class="role-buttons">
        <button class="secondary-btn" id="btn-driver">–Ø –≤–æ–¥–∏—Ç–µ–ª—å</button>
        <button class="secondary-btn" id="btn-passenger">–Ø –ø–∞—Å—Å–∞–∂–∏—Ä</button>
      </div>
      <div class="info" id="role-info">
        –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.
      </div>
    </div>

    <!-- Tabs: Driver -->
    <div class="tabs-bar hidden" id="driver-tabs-bar">
      <button class="tab-btn active" data-role="driver" data-tab="create">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="tab-btn" data-role="driver" data-tab="active">–ê–∫—Ç–∏–≤–Ω–∞—è</button>
      <button class="tab-btn" data-role="driver" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="tab-btn" data-role="driver" data-tab="plans">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button>
    </div>

    <!-- Tabs: Passenger -->
    <div class="tabs-bar hidden" id="passenger-tabs-bar">
      <button class="tab-btn active" data-role="passenger" data-tab="trips">–ü–æ–µ–∑–¥–∫–∏</button>
      <button class="tab-btn" data-role="passenger" data-tab="bookings">–ú–æ–∏ –±—Ä–æ–Ω–∏</button>
      <button class="tab-btn" data-role="passenger" data-tab="plan">–ü–ª–∞–Ω</button>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏ + –º–∞—à–∏–Ω–∞ -->
    <div class="card hidden" id="driver-section" data-collapsible="1" data-title="–í–æ–¥–∏—Ç–µ–ª—å: –ø–æ–µ–∑–¥–∫–∞ –∏ –º–∞—à–∏–Ω–∞">
      <div class="subtitle">–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</div>

      <div class="field">
        <label for="from-city">–û—Ç–∫—É–¥–∞</label>
        <input id="from-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ—á–∏" />
      </div>
      <div class="field">
        <label for="to-city">–ö—É–¥–∞</label>
        <input id="to-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–æ–∑–∞ –ü–ª–∞—Ç–æ" />
      </div>
      <div class="field">
        <label for="departure-time">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤—ã–µ–∑–¥–∞</label>
        <input id="departure-time" type="datetime-local" />
      </div>
      <div class="field field-inline">
        <div class="field">
          <label for="seats-total">–ú–µ—Å—Ç</label>
          <input id="seats-total" type="number" min="1" max="8" value="3" />
        </div>
        <div class="field">
          <label for="price-per-seat">–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ</label>
          <input id="price-per-seat" type="number" min="0" step="10" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" />
        </div>
      </div>
      <div class="field">
        <label for="trip-note">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <input id="trip-note" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –µ–¥—É —á–µ—Ä–µ–∑ –†–æ–∑—É –•–æ–ª–ª" />
      </div>

      <button class="primary-btn" id="btn-create-trip">–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
      <div class="info" id="driver-message"></div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;" />

      <div class="subtitle">–ú–æ—è –º–∞—à–∏–Ω–∞</div>
      <div class="field field-inline">
        <div class="field">
          <label for="car-make">–ú–∞—Ä–∫–∞ / –º–æ–¥–µ–ª—å</label>
          <input id="car-make" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Kia Rio" />
        </div>
        <div class="field">
          <label for="car-color">–¶–≤–µ—Ç</label>
          <input id="car-color" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–ª—ã–π" />
        </div>
      </div>
      <div class="field">
        <label for="car-plate">–ù–æ–º–µ—Ä</label>
        <input id="car-plate" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê123–í–° 123" />
      </div>
      <button class="secondary-btn" id="btn-save-car">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—à–∏–Ω—É</button>
      <div class="info" id="driver-car-message"></div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ -->
    <div class="card hidden" id="driver-active" data-collapsible="1" data-title="–í–æ–¥–∏—Ç–µ–ª—å: –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞">
      <div class="subtitle">–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞</div>
      <div class="info small-text">
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–ª–∏–∂–∞–π—à–∞—è –ø–æ–µ–∑–¥–∫–∞ (–≤–∫–ª—é—á–∞—è 10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞).
      </div>
      <button class="secondary-btn" id="btn-load-active-trip">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <div class="info" id="driver-active-info">
        –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button class="secondary-btn" id="btn-active-passengers">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button>
        <button class="danger-btn" id="btn-cancel-active-trip">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
      </div>
      <div class="info" id="driver-bookings-title" style="margin-top:8px;"></div>
      <div id="driver-bookings-list"></div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –∏—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫ -->
    <div class="card hidden" id="driver-history" data-collapsible="1" data-title="–í–æ–¥–∏—Ç–µ–ª—å: –º–æ–∏ –ø–æ–µ–∑–¥–∫–∏">
      <div class="subtitle">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</div>
      <button class="secondary-btn" id="btn-load-driver-trips">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      <div class="info" id="driver-trips-list">
        –ü–æ–µ–∑–¥–∫–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ -->
    <div class="card hidden" id="driver-passenger-plans">
      <div class="collapsible-header" id="driver-passenger-plans-header">
        <span>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤</span>
        <span class="arrow" id="driver-passenger-plans-arrow">‚ñ∂</span>
      </div>
      <div class="info small-text">
        –ó–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–±—Ä–∞—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞¬ª, —á—Ç–æ–±—ã –µ–º—É –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        ¬´–í–∞—Å –∑–∞–±–µ—Ä—ë—Ç –≤–æ–¥–∏—Ç–µ–ª—å¬ª.
      </div>
      <div id="driver-passenger-plans-content" class="hidden" style="margin-top:8px;">
        <div class="info" id="driver-passenger-plans-list">
          –ó–∞–ø—Ä–æ—Å—ã –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
        </div>
        <button class="secondary-btn" id="btn-reload-driver-passenger-plans" style="margin-top:6px;">
          –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
        </button>
      </div>
    </div>

    <!-- –ü–∞—Å—Å–∞–∂–∏—Ä: —Å–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫ -->
    <div class="card hidden" id="passenger-section" data-collapsible="1" data-title="–ü–∞—Å—Å–∞–∂–∏—Ä: –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏">
      <div class="subtitle">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</div>
      <div class="info small-text">
        –°–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫ —Å –µ—â—ë —Å–≤–æ–±–æ–¥–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏ –∏ —Å –≤—ã–µ–∑–¥–æ–º –Ω–µ —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥.
      </div>
      <div class="filters" id="passenger-filters">
        <div class="field">
          <label>–û—Ç–∫—É–¥–∞</label>
          <select id="filter-from">
            <option value="">–õ—é–±–æ–π</option>
          </select>
        </div>
        <div class="field">
          <label>–ö—É–¥–∞</label>
          <select id="filter-to">
            <option value="">–õ—é–±–æ–π</option>
          </select>
        </div>
        <div class="field">
          <label>–î–∞—Ç–∞</label>
          <select id="filter-day">
            <option value="any">–õ—é–±–∞—è</option>
            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="tomorrow">–ó–∞–≤—Ç—Ä–∞</option>
          </select>
        </div>
        <div class="field">
          <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <select id="filter-sort">
            <option value="time_asc">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Üë</option>
            <option value="time_desc">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Üì</option>
          </select>
        </div>
        <div class="actions">
          <button class="secondary-btn" id="btn-apply-filters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button class="secondary-btn" id="btn-reset-filters">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <button class="secondary-btn" id="btn-refresh-trips">–û–±–Ω–æ–≤–∏—Ç—å</button>

      <div id="trips-list" class="info">
        –ü–æ–µ–∑–¥–∫–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –ü–∞—Å—Å–∞–∂–∏—Ä: –º–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏ -->
    <div class="card hidden" id="passenger-active" data-collapsible="1" data-title="–ü–∞—Å—Å–∞–∂–∏—Ä: –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏">
      <div class="subtitle">–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
      <button class="secondary-btn" id="btn-load-passenger-active">–ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</button>
      <div class="info" id="passenger-active-list">
        –ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –ü–∞—Å—Å–∞–∂–∏—Ä: –ø–ª–∞–Ω—ã –ø–æ–µ–∑–¥–æ–∫ -->
    <div class="card hidden" id="passenger-plans-section" data-collapsible="1" data-title="–ü–∞—Å—Å–∞–∂–∏—Ä: –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏">
      <div class="subtitle">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</div>
      <div class="field">
        <label for="plan-from-city">–û—Ç–∫—É–¥–∞</label>
        <input id="plan-from-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ—á–∏" />
      </div>
      <div class="field">
        <label for="plan-to-city">–ö—É–¥–∞</label>
        <input id="plan-to-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–æ–∑–∞ –ü–ª–∞—Ç–æ" />
      </div>
      <div class="field">
        <label for="plan-desired-time">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
        <input id="plan-desired-time" type="datetime-local" />
      </div>
      <div class="field">
        <label for="plan-seats-needed">–°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –Ω—É–∂–Ω–æ</label>
        <input id="plan-seats-needed" type="number" min="1" max="8" value="1" />
      </div>
      <div class="field">
        <label for="plan-note">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <input id="plan-note" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–¥–æ–π–¥—ë—Ç –≤—ã–µ–∑–¥ —Å 8 –¥–æ 10 —É—Ç—Ä–∞" />
      </div>
      <button class="secondary-btn" id="btn-create-passenger-plan">–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –ø–æ–µ–∑–¥–∫–∏</button>
      <div class="info" id="passenger-plan-message"></div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;" />

      <div class="subtitle">–ú–æ–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</div>
      <div class="info small-text">
        –ö–æ–≥–¥–∞ –≤–æ–¥–∏—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤–∞—à –ø–ª–∞–Ω, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–í–∞—Å –∑–∞–±–µ—Ä—ë—Ç –≤–æ–¥–∏—Ç–µ–ª—å¬ª.
      </div>
      <div class="info" id="passenger-plans-list">
        –ü–ª–∞–Ω—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –±–ª–æ–∫ –æ–ø–ª–∞—Ç—ã -->
    <div class="card hidden" id="driver-payment-block" data-collapsible="1" data-title="–í–æ–¥–∏—Ç–µ–ª—å: –æ–ø–ª–∞—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏">
      <div class="subtitle">–û–ø–ª–∞—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
      <div class="info" id="driver-payment-info">
        –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –ø–æ–µ–∑–¥–∫–∞—Ö.
      </div>
      <div class="info" id="driver-payment-requisites"></div>

      <div class="field hidden" id="driver-payment-copy-block">
        <label for="driver-payment-details-copy">–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</label>
        <textarea id="driver-payment-details-copy" rows="3" readonly style="width:100%;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:13px;"></textarea>
        <button class="secondary-btn" id="btn-copy-payment-details">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</button>
      </div>

      <div class="field">
        <label for="driver-payment-file">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫ –æ–± –æ–ø–ª–∞—Ç–µ</label>
        <input id="driver-payment-file" type="file" />
      </div>
      <button class="secondary-btn" id="btn-upload-payment">–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫</button>
    </div>

    <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
    <div class="card hidden" id="admin-section" data-collapsible="1" data-title="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å">
      <div class="subtitle">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å–µ—Ä–≤–∏—Å–∞</div>

      <div class="info" id="admin-settings-info">
        –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫.
      </div>

      <div class="field">
        <label for="admin-payment-details">–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã</label>
        <textarea id="admin-payment-details" rows="3" style="width:100%;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:13px;"></textarea>
      </div>

      <div class="role-buttons" style="margin-top:4px;">
        <button class="secondary-btn" id="btn-disable-pay">–°–¥–µ–ª–∞—Ç—å —Å–µ—Ä–≤–∏—Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º</button>
        <button class="primary-btn" id="btn-enable-pay">–í–∫–ª—é—á–∏—Ç—å –æ–ø–ª–∞—Ç—É –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π</button>
      </div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;" />

      <div class="subtitle">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <button class="secondary-btn" id="btn-load-stats">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
      <div class="info" id="admin-stats-info">
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.
      </div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;" />

      <div class="subtitle">–í–æ–¥–∏—Ç–µ–ª–∏ –∑–∞ –¥–µ–Ω—å</div>
      <div class="field">
        <label for="admin-drivers-date">–î–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <input id="admin-drivers-date" type="date" />
      </div>
      <button class="secondary-btn" id="btn-load-daily-drivers">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π</button>
      <div class="info" id="admin-daily-drivers">
        –°–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    const ADMIN_ID = 504348666;

    let currentTelegramUser = null;
    let activeTripId = null;

    const CITIES = ["", "–°–æ—á–∏", "–ê–¥–ª–µ—Ä", "–ê—ç—Ä–æ–ø–æ—Ä—Ç –°–æ—á–∏", "–ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞", "–†–æ–∑–∞ –•—É—Ç–æ—Ä", "–†–æ–∑–∞ –ü–ª–∞—Ç–æ", "–ì–∞–∑–ø—Ä–æ–º", "–≠—Å—Ç–æ-–°–∞–¥–æ–∫"];

    const userInfoDiv = document.getElementById('user-info');
    userInfoDiv.innerHTML += `<br/>URL: ${window.location.href}`;

    const btnDriver = document.getElementById('btn-driver');
    const btnPassenger = document.getElementById('btn-passenger');
    const roleInfo = document.getElementById('role-info');

    const driverSection = document.getElementById('driver-section');
    const driverHistory = document.getElementById('driver-history');
    const driverActive = document.getElementById('driver-active');

    const passengerSection = document.getElementById('passenger-section');
    const passengerActiveSection = document.getElementById('passenger-active');
    const driverMessage = document.getElementById('driver-message');
    const tripsList = document.getElementById('trips-list');

    const btnLoadDriverTrips = document.getElementById('btn-load-driver-trips');
    const driverTripsList = document.getElementById('driver-trips-list');
    const driverBookingsTitle = document.getElementById('driver-bookings-title');
    const driverBookingsList = document.getElementById('driver-bookings-list');

    const btnLoadActiveTrip = document.getElementById('btn-load-active-trip');
    const btnActivePassengers = document.getElementById('btn-active-passengers');
    const btnCancelActiveTrip = document.getElementById('btn-cancel-active-trip');
    const driverActiveInfo = document.getElementById('driver-active-info');

    const driverCarMessage = document.getElementById('driver-car-message');

    const driverPaymentBlock = document.getElementById('driver-payment-block');
    const driverPaymentInfo = document.getElementById('driver-payment-info');
    const driverPaymentRequisites = document.getElementById('driver-payment-requisites');
    const driverPaymentCopyBlock = document.getElementById('driver-payment-copy-block');
    const driverPaymentDetailsCopy = document.getElementById('driver-payment-details-copy');
    const btnCopyPaymentDetails = document.getElementById('btn-copy-payment-details');
    const driverPaymentFile = document.getElementById('driver-payment-file');
    const btnUploadPayment = document.getElementById('btn-upload-payment');

    const adminSection = document.getElementById('admin-section');
    const adminSettingsInfo = document.getElementById('admin-settings-info');
    const adminPaymentDetails = document.getElementById('admin-payment-details');
    const btnEnablePay = document.getElementById('btn-enable-pay');
    const btnDisablePay = document.getElementById('btn-disable-pay');
    const btnLoadStats = document.getElementById('btn-load-stats');
    const adminStatsInfo = document.getElementById('admin-stats-info');
    const btnLoadDailyDrivers = document.getElementById('btn-load-daily-drivers');
    const adminDailyDrivers = document.getElementById('admin-daily-drivers');

    const btnLoadPassengerActive = document.getElementById('btn-load-passenger-active');
    const passengerActiveList = document.getElementById('passenger-active-list');

    const planFromCityInput = document.getElementById('plan-from-city');
    const planToCityInput = document.getElementById('plan-to-city');
    const planDesiredTimeInput = document.getElementById('plan-desired-time');
    const planSeatsNeededInput = document.getElementById('plan-seats-needed');
    const planNoteInput = document.getElementById('plan-note');
    const btnCreatePassengerPlan = document.getElementById('btn-create-passenger-plan');
    const passengerPlanMessage = document.getElementById('passenger-plan-message');
    const passengerPlansList = document.getElementById('passenger-plans-list');

    const driverPassengerPlansHeader = document.getElementById('driver-passenger-plans-header');
    const driverPassengerPlansArrow = document.getElementById('driver-passenger-plans-arrow');
    const driverPassengerPlansContent = document.getElementById('driver-passenger-plans-content');
    const driverPassengerPlansList = document.getElementById('driver-passenger-plans-list');
    const btnReloadDriverPassengerPlans = document.getElementById('btn-reload-driver-passenger-plans');

    const filterFrom = document.getElementById('filter-from');
    const filterTo = document.getElementById('filter-to');
    const filterDay = document.getElementById('filter-day');
    const filterSort = document.getElementById('filter-sort');
    const btnApplyFilters = document.getElementById('btn-apply-filters');
    const btnResetFilters = document.getElementById('btn-reset-filters');

    // –§–∏–∫—Å –¥–ª—è Telegram Desktop
    if (tg && (!tg.initDataUnsafe || !tg.initDataUnsafe.user)) {
      const hash = window.location.hash.substring(1);
      if (hash.startsWith('tgWebAppData=')) {
        const params = new URLSearchParams(hash);
        const dataStr = params.get('tgWebAppData');
        if (dataStr) {
          const dataParams = new URLSearchParams(dataStr);
          const userJson = dataParams.get('user');
          if (userJson) {
            try {
              tg.initDataUnsafe = tg.initDataUnsafe || {};
              tg.initDataUnsafe.user = JSON.parse(decodeURIComponent(userJson));
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ user –∏–∑ hash:', e);
            }
          }
        }
      }
    }

    // –¢–≤–æ—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      tg.expand();
      currentTelegramUser = tg.initDataUnsafe.user;

      userInfoDiv.textContent =
        `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${currentTelegramUser.first_name || ''} ${currentTelegramUser.last_name || ''} (@${currentTelegramUser.username || '–±–µ–∑ username'})`;

      fetch('/api/init-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: currentTelegramUser }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) console.error('–û—à–∏–±–∫–∞ init-user:', data.error);
          if (currentTelegramUser && String(currentTelegramUser.id) === String(ADMIN_ID)) {
            adminSection.classList.remove('hidden');
            loadAdminSettings();
          } else {
            adminSection.classList.add('hidden');
          }
        })
        .catch((err) => console.error('–û—à–∏–±–∫–∞ init-user:', err));
    } else {
      userInfoDiv.textContent = '–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.';
    }

    // –£—Ç–∏–ª–∏—Ç—ã
    function setButtonLoading(btn, loading) {
      btn.disabled = loading;
      if (loading) {
        btn.dataset.originalText = btn.textContent;
        btn.textContent = '‚è≥';
      } else if (btn.dataset.originalText) {
        btn.textContent = btn.dataset.originalText;
        delete btn.dataset.originalText;
      }
    }

    function formatName(first, last, username) {
      const full = `${first || ''} ${last || ''}`.trim();
      const u = username ? ` @${username}` : '';
      return (full || '–±–µ–∑ –∏–º–µ–Ω–∏') + u;
    }

    function formatDateReadable(str) {
      if (!str) return str;
      const d = new Date(str);
      if (isNaN(d.getTime())) return str;
      const day = d.getDate();
      const month = d.getMonth();
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      const MONTHS = ["—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è","–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"];
      return `${day} ${MONTHS[month]}, ${hours}:${minutes}`;
    }

    function isPlanStillActive(desiredTimeStr) {
      if (!desiredTimeStr) return true;
      const ts = Date.parse(desiredTimeStr);
      if (!Number.isFinite(ts)) return true;
      const now = Date.now();
      const cutoff = now - 20 * 60 * 1000;
      return ts >= cutoff;
    }

    // Collapsible cards
    function initCollapsibleCards() {
      const cards = document.querySelectorAll('.card[data-collapsible="1"]');
      cards.forEach(card => {
        if (card.dataset.initialized) return;
        card.dataset.initialized = '1';

        const title = card.dataset.title || '–ë–ª–æ–∫';
        const content = document.createElement('div');
        content.className = 'card-collapsible-content';
        while (card.children.length > 0) content.appendChild(card.children[0]);

        const header = document.createElement('div');
        header.className = 'collapsible-header';
        header.innerHTML = `<span>${title}</span><span class="arrow">‚ñ∂</span>`;

        card.appendChild(header);
        card.appendChild(content);
        card.classList.add('card-collapsed');

        header.addEventListener('click', () => {
          card.classList.toggle('card-collapsed');
          header.querySelector('.arrow').classList.toggle('rotated');
        });
      });
    }

    // Tabs –∏ —Ä–æ–ª–∏
    let currentRole = null;

    function showDriverTab(tab) {
      // —Ç–≤–æ—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ç–∞–±–æ–≤
      // (–≤—Å—Ç–∞–≤—å —Å—é–¥–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞)
    }

    function showPassengerTab(tab) {
      // —Ç–≤–æ—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
    }

    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (loadTrips, renderTrips, createBooking, loadPassengerPlans, renderPassengerPlans, loadDriverPassengerPlans, renderDriverPassengerPlans, loadDriverPaymentInfo –∏ —Ç.–¥.) ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã

    // –§–∏–ª—å—Ç—Ä—ã
    function populateCitySelects() {
      [filterFrom, filterTo].forEach(select => {
        select.innerHTML = '';
        CITIES.forEach(city => {
          const opt = document.createElement('option');
          opt.value = city;
          opt.textContent = city || '–õ—é–±–æ–π';
          select.appendChild(opt);
        });
      });
    }

    let currentFilters = { from: '', to: '', day: 'any', sort: 'time_asc' };

    function applyFilters() {
      currentFilters.from = filterFrom.value;
      currentFilters.to = filterTo.value;
      currentFilters.day = filterDay.value;
      currentFilters.sort = filterSort.value;
      loadTrips();
    }

    function resetFilters() {
      filterFrom.value = '';
      filterTo.value = '';
      filterDay.value = 'any';
      filterSort.value = 'time_asc';
      applyFilters();
    }

    filterFrom.addEventListener('change', applyFilters);
    filterTo.addEventListener('change', applyFilters);
    filterDay.addEventListener('change', applyFilters);
    filterSort.addEventListener('change', applyFilters);
    btnApplyFilters.addEventListener('click', applyFilters);
    btnResetFilters.addEventListener('click', resetFilters);

    // –ó–∞—â–∏—Ç–∞ –∫–Ω–æ–ø–æ–∫ (–ø—Ä–∏–º–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞)
    btnCreatePassengerPlan.addEventListener('click', function(e) {
      const btn = this;
      if (btn.disabled) return;
      setButtonLoading(btn, true);
      // –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞
      // –≤ –∫–æ–Ω—Ü–µ –≤—Å–µ—Ö then/catch:
      setButtonLoading(btn, false);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initCollapsibleCards();
    populateCitySelects();

    // –ö–Ω–æ–ø–∫–∏ —Ä–æ–ª–µ–π (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ)
    btnDriver.addEventListener('click', () => {
      if (!currentTelegramUser) return;
      // –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥
    });

    btnPassenger.addEventListener('click', () => {
      if (!currentTelegramUser) return;
      // –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥
    });

    // –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  </script>
</body>
</html>