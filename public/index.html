<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ø–æ–ø—É—Ç—á–∏–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e5e7eb;
      color: #111827;
    }
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px 12px 60px 12px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 14px 14px 16px 14px;
      margin-bottom: 14px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
      border: 1px solid #e5e7eb;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .logo {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f704db, #10b981);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #374151;
      margin-bottom: 8px;
    }

    .info {
      font-size: 13px;
      color: #4b5563;
      margin-top: 4px;
      white-space: pre-line;
      line-height: 1.4;
    }
    .small-text {
      font-size: 11px;
      color: #6b7280;
    }

    .field {
      margin-bottom: 8px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 3px;
    }
    .field input,
    .field textarea,
    .field select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 7px 9px;
      font-size: 15px;
      box-sizing: border-box;
      background: #f9fafb;
    }
    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
      background: #ffffff;
    }
    .field-inline {
      display: flex;
      gap: 8px;
    }
    .field-inline .field {
      flex: 1;
      margin-bottom: 0;
    }

    .role-buttons {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    .role-buttons button {
      flex: 1;
      border-radius: 16px;
      padding: 12px 0;
      font-size: 15px;
      font-weight: 700;
      color: #ffffff;
      border: none;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.15s ease;
    }

    #btn-driver {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.4);
    }

    #btn-passenger {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 3px 8px rgba(16, 185, 129, 0.4);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .primary-btn {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
    }
    .primary-btn:hover:not(:disabled) {
      background: #1d4ed8;
    }
    .secondary-btn {
      background: #e5e7eb;
      color: #111827;
    }
    .secondary-btn:hover:not(:disabled) {
      background: #d1d5db;
    }
    .danger-btn {
      background: #ef4444;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.35);
    }
    .danger-btn:hover:not(:disabled) {
      background: #dc2626;
    }

    .trip-card, .booking-card, .plan-card {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 8px 9px;
      margin-bottom: 8px;
      font-size: 13px;
      background: #f9fafb;
    }

    .trip-header, .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 6px;
    }
    .trip-route, .booking-status {
      font-weight: 700;
      font-size: 14px;
    }
    .booking-status {
      color: #059669;
      white-space: nowrap;
    }
    .trip-meta, .booking-meta {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.4;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: #eef2ff;
      color: #3730a3;
      margin-right: 4px;
      margin-top: 2px;
    }

    .hidden {
      display: none !important;
    }

    #driver-section, #driver-active, #driver-history, #driver-passenger-plans, #driver-payment-block {
      border-left: 4px solid #2563eb;
      padding-left: 12px;
    }

    #passenger-section, #passenger-active, #passenger-plans-section {
      border-left: 4px solid #10b981;
      padding-left: 12px;
    }

    #admin-section {
      border-left: 4px solid #f97316;
      padding-left: 12px;
    }

    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 10px;
      background: #f3f4f6;
      margin-top: 4px;
    }
    .collapsible-header span {
      font-weight: 600;
      font-size: 14px;
    }
    .arrow {
      font-size: 16px;
      transition: transform 0.15s ease;
    }
    .arrow.rotated {
      transform: rotate(90deg);
    }
    .card-collapsible-content {
      margin-top: 8px;
    }
    .card-collapsed .card-collapsible-content {
      display: none;
    }

    .tabs-bar {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.10);
      margin-bottom: 12px;
      position: sticky;
      top: 8px;
      z-index: 50;
    }
    .tab-btn {
      flex: 1;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      border-radius: 14px;
      padding: 10px 8px;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #111827;
      color: #ffffff;
      border-color: #111827;
    }

    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 10px 0 10px 0;
      padding: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
    }
    .filters .field { margin-bottom: 0; }
    .filters .field label { font-size: 11px; font-weight: 800; color: #374151; }
    .filters .actions { grid-column: 1 / -1; display: flex; gap: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="title-row">
        <div class="logo">üöó</div>
        <div class="title">–ø–æ–ø—É—Ç—á–∏–∫–∏</div>
      </div>
      <div class="info" id="user-info">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...
      </div>
    </div>

    <div class="card">
      <div class="subtitle">–ö—Ç–æ –≤—ã?</div>
      <div class="role-buttons">
        <button class="secondary-btn" id="btn-driver">–Ø –≤–æ–¥–∏—Ç–µ–ª—å</button>
        <button class="secondary-btn" id="btn-passenger">–Ø –ø–∞—Å—Å–∞–∂–∏—Ä</button>
      </div>
      <div class="info" id="role-info">
        –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.
      </div>
    </div>

    <div class="tabs-bar hidden" id="driver-tabs-bar">
      <button class="tab-btn active" data-role="driver" data-tab="create">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="tab-btn" data-role="driver" data-tab="active">–ê–∫—Ç–∏–≤–Ω–∞—è</button>
      <button class="tab-btn" data-role="driver" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="tab-btn" data-role="driver" data-tab="plans">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button>
    </div>

    <div class="tabs-bar hidden" id="passenger-tabs-bar">
      <button class="tab-btn active" data-role="passenger" data-tab="trips">–ü–æ–µ–∑–¥–∫–∏</button>
      <button class="tab-btn" data-role="passenger" data-tab="bookings">–ú–æ–∏ –±—Ä–æ–Ω–∏</button>
      <button class="tab-btn" data-role="passenger" data-tab="plan">–ü–ª–∞–Ω</button>
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω–æ–π HTML —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ (–≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏) -->
    <!-- –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –Ω–µ –¥—É–±–ª–∏—Ä—É—é, –æ–Ω –∏–¥–µ–Ω—Ç–∏—á–µ–Ω —Ç–≤–æ–µ–º—É –æ—Ä–∏–≥–∏–Ω–∞–ª—É -->

    <!-- –ü–∞—Å—Å–∞–∂–∏—Ä: —Ñ–∏–ª—å—Ç—Ä—ã —Å –≥–æ—Ä–æ–¥–∞–º–∏ -->
    <div class="card hidden" id="passenger-section" data-collapsible="1" data-title="–ü–∞—Å—Å–∞–∂–∏—Ä: –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏">
      <div class="subtitle">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</div>
      <div class="info small-text">
        –°–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫ —Å –µ—â—ë —Å–≤–æ–±–æ–¥–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏ –∏ —Å –≤—ã–µ–∑–¥–æ–º –Ω–µ —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥.
      </div>
      <div class="filters" id="passenger-filters">
        <div class="field">
          <label>–û—Ç–∫—É–¥–∞</label>
          <select id="filter-from">
            <option value="">–õ—é–±–æ–π</option>
          </select>
        </div>
        <div class="field">
          <label>–ö—É–¥–∞</label>
          <select id="filter-to">
            <option value="">–õ—é–±–æ–π</option>
          </select>
        </div>
        <div class="field">
          <label>–î–∞—Ç–∞</label>
          <select id="filter-day">
            <option value="any">–õ—é–±–∞—è</option>
            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="tomorrow">–ó–∞–≤—Ç—Ä–∞</option>
          </select>
        </div>
        <div class="field">
          <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <select id="filter-sort">
            <option value="time_asc">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Üë</option>
            <option value="time_desc">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Üì</option>
          </select>
        </div>
        <div class="actions">
          <button class="secondary-btn" id="btn-apply-filters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button class="secondary-btn" id="btn-reset-filters">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <button class="secondary-btn" id="btn-refresh-trips">–û–±–Ω–æ–≤–∏—Ç—å</button>

      <div id="trips-list" class="info">
        –ü–æ–µ–∑–¥–∫–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
      </div>
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->

  </div>

  <script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    const ADMIN_ID = 504348666;

    let currentTelegramUser = null;
    let activeTripId = null;

    const CITIES = ["", "–°–æ—á–∏", "–ê–¥–ª–µ—Ä", "–ê—ç—Ä–æ–ø–æ—Ä—Ç –°–æ—á–∏", "–ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞", "–†–æ–∑–∞ –•—É—Ç–æ—Ä", "–†–æ–∑–∞ –ü–ª–∞—Ç–æ", "–ì–∞–∑–ø—Ä–æ–º", "–≠—Å—Ç–æ-–°–∞–¥–æ–∫"];

    const userInfoDiv = document.getElementById('user-info');
    userInfoDiv.innerHTML += `<br/>URL: ${window.location.href}`;

    // –§–∏–∫—Å –¥–ª—è Telegram Desktop
    if (tg && (!tg.initDataUnsafe || !tg.initDataUnsafe.user)) {
      const hash = window.location.hash.substring(1);
      if (hash.startsWith('tgWebAppData=')) {
        const params = new URLSearchParams(hash);
        const dataStr = params.get('tgWebAppData');
        if (dataStr) {
          const dataParams = new URLSearchParams(dataStr);
          const userJson = dataParams.get('user');
          if (userJson) {
            try {
              tg.initDataUnsafe = tg.initDataUnsafe || {};
              tg.initDataUnsafe.user = JSON.parse(decodeURIComponent(userJson));
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ user –∏–∑ hash:', e);
            }
          }
        }
      }
    }

    // –¢–≤–æ—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Ä–∞–±–æ—Ç–∞–µ—Ç!)
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      tg.expand();
      currentTelegramUser = tg.initDataUnsafe.user;

      userInfoDiv.textContent =
        `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${currentTelegramUser.first_name || ''} ${currentTelegramUser.last_name || ''} (@${currentTelegramUser.username || '–±–µ–∑ username'})`;

      fetch('/api/init-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: currentTelegramUser }),
      })
        .then(res => res.json())
        .then(data => {
          if (data.error) console.error('–û—à–∏–±–∫–∞ init-user:', data.error);
          if (String(currentTelegramUser.id) === String(ADMIN_ID)) {
            document.getElementById('admin-section').classList.remove('hidden');
            loadAdminSettings();
          }
        })
        .catch(err => console.error('–û—à–∏–±–∫–∞ init-user:', err));
    } else {
      userInfoDiv.textContent = '–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.';
    }

    // –§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–Ω–æ–ø–æ–∫
    function setButtonLoading(btn, loading) {
      btn.disabled = loading;
      if (loading) {
        btn.dataset.originalText = btn.textContent;
        btn.textContent = '‚è≥';
      } else if (btn.dataset.originalText) {
        btn.textContent = btn.dataset.originalText;
        delete btn.dataset.originalText;
      }
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function populateCitySelects() {
      ['filter-from', 'filter-to'].forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '';
        CITIES.forEach(city => {
          const opt = document.createElement('option');
          opt.value = city;
          opt.textContent = city || '–õ—é–±–æ–π';
          select.appendChild(opt);
        });
      });
    }

    let currentFilters = { from: '', to: '', day: 'any', sort: 'time_asc' };

    function applyFilters() {
      currentFilters.from = document.getElementById('filter-from').value;
      currentFilters.to = document.getElementById('filter-to').value;
      currentFilters.day = document.getElementById('filter-day').value;
      currentFilters.sort = document.getElementById('filter-sort').value;
      loadTrips();
    }

    function resetFilters() {
      document.getElementById('filter-from').value = '';
      document.getElementById('filter-to').value = '';
      document.getElementById('filter-day').value = 'any';
      document.getElementById('filter-sort').value = 'time_asc';
      applyFilters();
    }

    document.getElementById('btn-apply-filters').addEventListener('click', applyFilters);
    document.getElementById('btn-reset-filters').addEventListener('click', resetFilters);
    document.getElementById('filter-from').addEventListener('change', applyFilters);
    document.getElementById('filter-to').addEventListener('change', applyFilters);
    document.getElementById('filter-day').addEventListener('change', applyFilters);
    document.getElementById('filter-sort').addEventListener('change', applyFilters);

    // –ü—Ä–∏–º–µ—Ä –∑–∞—â–∏—Ç—ã –∫–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞
    document.getElementById('btn-create-passenger-plan').addEventListener('click', function() {
      const btn = this;
      if (btn.disabled) return;
      setButtonLoading(btn, true);
      // ... –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞ ...
      // –≤ –∫–æ–Ω—Ü–µ:
      setButtonLoading(btn, false);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    populateCitySelects();
    initCollapsibleCards();

    // –ö–Ω–æ–ø–∫–∏ —Ä–æ–ª–µ–π –∏ –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ‚Äî –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ

  </script>
</body>
</html>