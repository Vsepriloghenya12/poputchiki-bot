<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ø–æ–ø—É—Ç—á–∏–∫–∏ ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    .app {
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 12px;
    }
    .logo-row {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 8px;
    }
    .logo-icon {
      position: relative;
      width: 48px;
      height: 48px;
      border-radius: 18px;
      background: radial-gradient(circle at 0% 0%, #e0f2fe, #eff6ff 30%, #1d4ed8 95%);
      box-shadow: 0 8px 14px rgba(15, 23, 42, 0.22);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo-icon::before {
      content: "";
      position: absolute;
      inset: 12px 2px 6px 18px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #a5b4fc);
      opacity: 0.9;
      transform: skewX(-18deg);
    }
    .logo-icon::after {
      content: "";
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #fbbf24;
      box-shadow:
        -10px -8px 0 rgba(15,23,42,0.12),
        0 0 0 3px rgba(248, 250, 252, 0.9);
      bottom: 6px;
      right: 6px;
    }
    .logo-car {
      position: relative;
      font-size: 22px;
      transform: translateX(-4px) translateY(-2px) rotate(-6deg);
      text-shadow:
        0 1px 0 rgba(15, 23, 42, 0.3),
        0 3px 6px rgba(15, 23, 42, 0.45);
    }
    .logo-text-primary {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: lowercase;
      color: #0f172a;
    }
    .logo-text-primary span {
      background: linear-gradient(135deg, #2563eb, #22c55e);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .logo-text-secondary {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }
    .subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .role-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .driver {
      background: #2563eb;
      color: white;
      flex: 1;
    }
    .passenger {
      background: #10b981;
      color: white;
      flex: 1;
    }
    .primary-btn {
      width: 100%;
      margin-top: 8px;
      background: #2563eb;
      color: white;
    }
    .secondary-btn {
      width: 100%;
      margin-top: 6px;
      background: #e5e7eb;
      color: #111827;
    }
    .info {
      font-size: 13px;
      color: #4b5563;
      margin-top: 8px;
    }
    .hidden {
      display: none;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .field-inline {
      display: flex;
      gap: 8px;
    }
    .field label {
      color: #4b5563;
    }
    .field input {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    .trip {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 0;
      font-size: 14px;
    }
    .trip:last-child {
      border-bottom: none;
    }
    .trip-header {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .trip-sub {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .trip-note {
      font-size: 12px;
      color: #374151;
      margin-bottom: 6px;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      margin-left: 4px;
    }
    .booking {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 0;
      font-size: 13px;
    }
    .booking:last-child {
      border-bottom: none;
    }
    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }
    .booking-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
    }
    .booking-status.no-show {
      background: #fee2e2;
      color: #b91c1c;
    }
    .booking-meta {
      font-size: 12px;
      color: #6b7280;
    }
    .danger-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      background: #fee2e2;
      color: #b91c1c;
      margin-top: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="logo-row">
        <div class="logo-icon">
          <div class="logo-car">üöò</div>
        </div>
        <div>
          <div class="logo-text-primary">
            <span>–ø–æ–ø—É—Ç—á–∏–∫–∏</span>
          </div>
          <div class="logo-text-secondary">
            –Ω–∞–π–¥–∏ —Ç–µ—Ö, –∫—Ç–æ —Å —Ç–æ–±–æ–π –ø–æ –ø—É—Ç–∏
          </div>
        </div>
      </div>
      <div id="user-info" class="info">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Telegram...
      </div>
    </div>

    <div class="card">
      <div class="subtitle">–ö—Ç–æ –≤—ã?</div>
      <div class="role-buttons">
        <button class="driver" id="btn-driver">–Ø –≤–æ–¥–∏—Ç–µ–ª—å</button>
        <button class="passenger" id="btn-passenger">–Ø –ø–∞—Å—Å–∞–∂–∏—Ä</button>
      </div>
      <div class="info" id="role-info">
        –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.
      </div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏ + –º–∞—à–∏–Ω–∞ -->
    <div class="card hidden" id="driver-section">
      <div class="subtitle">–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</div>

      <div class="field">
        <label for="from-city">–û—Ç–∫—É–¥–∞</label>
        <input id="from-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ—á–∏" />
      </div>
      <div class="field">
        <label for="to-city">–ö—É–¥–∞</label>
        <input id="to-city" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–æ–∑–∞ –ü–ª–∞—Ç–æ" />
      </div>
      <div class="field">
        <label for="departure-time">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤—ã–µ–∑–¥–∞</label>
        <input id="departure-time" type="datetime-local" />
      </div>
      <div class="field field-inline">
        <div class="field">
          <label for="seats-total">–ú–µ—Å—Ç</label>
          <input id="seats-total" type="number" min="1" max="8" value="3" />
        </div>
        <div class="field">
          <label for="price-per-seat">–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ</label>
          <input id="price-per-seat" type="number" min="0" step="10" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" />
        </div>
      </div>
      <div class="field">
        <label for="trip-note">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <input id="trip-note" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –µ–¥—É —á–µ—Ä–µ–∑ –†–æ–∑—É –•–æ–ª–ª" />
      </div>

      <button class="primary-btn" id="btn-create-trip">–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
      <div class="info" id="driver-message"></div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;" />

      <div class="subtitle">–ú–æ—è –º–∞—à–∏–Ω–∞</div>
      <div class="field field-inline">
        <div class="field">
          <label for="car-make">–ú–∞—Ä–∫–∞</label>
          <input id="car-make" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Kia Rio" />
        </div>
        <div class="field">
          <label for="car-color">–¶–≤–µ—Ç</label>
          <input id="car-color" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–ª—ã–π" />
        </div>
      </div>
      <div class="field">
        <label for="car-plate">–ù–æ–º–µ—Ä</label>
        <input id="car-plate" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: A123BC 123" />
      </div>
      <button class="secondary-btn" id="btn-save-car">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—à–∏–Ω—É</button>
      <div class="info" id="driver-car-message"></div>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ -->
    <div class="card hidden" id="driver-active">
      <div class="subtitle">–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞</div>
      <div class="info" id="driver-active-info">
        –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.
      </div>
      <button class="secondary-btn" id="btn-load-active-trip">–û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–µ–∑–¥–∫—É</button>
      <button class="secondary-btn hidden" id="btn-active-passengers">–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏</button>
    </div>

    <!-- –í–æ–¥–∏—Ç–µ–ª—å: –∏—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫ -->
    <div class="card hidden" id="driver-history">
      <div class="subtitle">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</div>
      <button class="secondary-btn" id="btn-load-driver-trips">–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
      <div class="info" id="driver-trips-list">
        –ò—Å—Ç–æ—Ä–∏—è –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.
      </div>
      <div class="info hidden" id="driver-bookings-title">
        –ü–∞—Å—Å–∞–∂–∏—Ä—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏:
      </div>
      <div class="info" id="driver-bookings-list"></div>
    </div>

    <!-- –ü–∞—Å—Å–∞–∂–∏—Ä: —Å–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫ -->
    <div class="card hidden" id="passenger-section">
      <div class="subtitle">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</div>
      <div id="trips-list" class="info">
        –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º ¬´–Ø –ø–∞—Å—Å–∞–∂–∏—Ä¬ª, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–µ–∑–¥–∫–∏.
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    let currentTelegramUser = null;
    let activeTripId = null;

    const userInfoDiv = document.getElementById('user-info');
    const btnDriver = document.getElementById('btn-driver');
    const btnPassenger = document.getElementById('btn-passenger');
    const roleInfo = document.getElementById('role-info');

    const driverSection = document.getElementById('driver-section');
    const driverHistory = document.getElementById('driver-history');
    const driverActive = document.getElementById('driver-active');

    const passengerSection = document.getElementById('passenger-section');
    const driverMessage = document.getElementById('driver-message');
    const tripsList = document.getElementById('trips-list');

    const btnLoadDriverTrips = document.getElementById('btn-load-driver-trips');
    const driverTripsList = document.getElementById('driver-trips-list');
    const driverBookingsTitle = document.getElementById('driver-bookings-title');
    const driverBookingsList = document.getElementById('driver-bookings-list');

    const btnLoadActiveTrip = document.getElementById('btn-load-active-trip');
    const btnActivePassengers = document.getElementById('btn-active-passengers');
    const driverActiveInfo = document.getElementById('driver-active-info');

    const driverCarMessage = document.getElementById('driver-car-message');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ Telegram
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      tg.expand();
      currentTelegramUser = tg.initDataUnsafe.user;

      userInfoDiv.textContent =
        `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${currentTelegramUser.first_name || ''} ${currentTelegramUser.last_name || ''} (@${currentTelegramUser.username || '–±–µ–∑ username'})`;

      fetch('/api/init-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: currentTelegramUser }),
      }).catch((err) => console.error('–û—à–∏–±–∫–∞ init-user:', err));
    } else {
      userInfoDiv.textContent =
        '–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.';
    }

    btnDriver.addEventListener('click', () => {
      if (!currentTelegramUser) {
        roleInfo.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º –≤–æ–¥–∏—Ç–µ–ª—è.';
        return;
      }
      roleInfo.textContent = '–†–µ–∂–∏–º –≤–æ–¥–∏—Ç–µ–ª—è: —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–æ–µ–∑–¥–∫–∏, —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –º–∞—à–∏–Ω—É –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–µ–∑–¥–∫—É.';
      driverSection.classList.remove('hidden');
      driverHistory.classList.remove('hidden');
      driverActive.classList.remove('hidden');
      passengerSection.classList.add('hidden');

      loadDriverProfile();
      loadDriverActiveTrip();
    });

    btnPassenger.addEventListener('click', () => {
      if (!currentTelegramUser) {
        roleInfo.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫–∏.';
        return;
      }
      roleInfo.textContent = '–†–µ–∂–∏–º –ø–∞—Å—Å–∞–∂–∏—Ä–∞: –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏ –±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –ø–æ–µ–∑–¥–∫–∏.';
      passengerSection.classList.remove('hidden');
      driverSection.classList.add('hidden');
      driverHistory.classList.add('hidden');
      driverActive.classList.add('hidden');
      loadTrips();
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏
    document.getElementById('btn-create-trip').addEventListener('click', () => {
      if (!currentTelegramUser) {
        driverMessage.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      const fromCity = document.getElementById('from-city').value.trim();
      const toCity = document.getElementById('to-city').value.trim();
      const departureTime = document.getElementById('departure-time').value;
      const seatsTotal = document.getElementById('seats-total').value;
      const pricePerSeat = document.getElementById('price-per-seat').value;
      const note = document.getElementById('trip-note').value.trim();

      if (!fromCity || !toCity || !departureTime || !seatsTotal || !pricePerSeat) {
        driverMessage.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.';
        return;
      }

      driverMessage.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏...';

      fetch('/api/trips', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          from_city: fromCity,
          to_city: toCity,
          departure_time: departureTime,
          seats_total: seatsTotal,
          price_per_seat: pricePerSeat,
          note,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverMessage.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            driverMessage.textContent = '–ü–æ–µ–∑–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞.';
            loadDriverActiveTrip();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–µ–∑–¥–∫–∏:', err);
          driverMessage.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–µ–∑–¥–∫–∏.';
        });
    });

    // –ú–∞—à–∏–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è
    function loadDriverProfile() {
      driverCarMessage.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—à–∏–Ω—ã...';

      fetch(`/api/driver/profile?telegram_id=${encodeURIComponent(String(currentTelegramUser.id))}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverCarMessage.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
            return;
          }
          const p = data.profile;
          document.getElementById('car-make').value = p.car_make || '';
          document.getElementById('car-color').value = p.car_color || '';
          document.getElementById('car-plate').value = p.car_plate || '';
          driverCarMessage.textContent = '–î–∞–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –û–Ω–∏ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö.';
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', err);
          driverCarMessage.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –º–∞—à–∏–Ω—ã.';
        });
    }

    document.getElementById('btn-save-car').addEventListener('click', () => {
      if (!currentTelegramUser) {
        driverCarMessage.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      const carMake = document.getElementById('car-make').value.trim();
      const carColor = document.getElementById('car-color').value.trim();
      const carPlate = document.getElementById('car-plate').value.trim();

      driverCarMessage.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

      fetch('/api/driver/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          car_make: carMake,
          car_color: carColor,
          car_plate: carPlate,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverCarMessage.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            driverCarMessage.textContent = '–ú–∞—à–∏–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞. –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –ø–∞—Å—Å–∞–∂–∏—Ä—É –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏.';
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—à–∏–Ω—ã:', err);
          driverCarMessage.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—à–∏–Ω—ã.';
        });
    });

    // –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞
    btnLoadActiveTrip.addEventListener('click', loadDriverActiveTrip);

    function loadDriverActiveTrip() {
      if (!currentTelegramUser) {
        driverActiveInfo.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      driverActiveInfo.textContent = '–ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏...';
      btnActivePassengers.classList.add('hidden');
      activeTripId = null;

      fetch(`/api/driver/active-trip?telegram_id=${encodeURIComponent(String(currentTelegramUser.id))}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverActiveInfo.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
            return;
          }

          const trip = data.trip;
          if (!trip) {
            driverActiveInfo.textContent = '–ê–∫—Ç–∏–≤–Ω—ã—Ö (–±—É–¥—É—â–∏—Ö) –ø–æ–µ–∑–¥–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.';
            return;
          }

          activeTripId = trip.id;
          btnActivePassengers.classList.remove('hidden');

          driverActiveInfo.innerHTML =
            `<strong>${trip.from_city} ‚Üí ${trip.to_city}</strong><br/>` +
            `–í—ã–µ–∑–¥: ${trip.departure_time}<br/>` +
            `–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: ${trip.bookings_count || 0}, —Å–≤–æ–±–æ–¥–Ω–æ: ${trip.seats_available}/${trip.seats_total}` +
            (trip.note ? `<br/>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${trip.note}` : '');
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏:', err);
          driverActiveInfo.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏.';
        });
    }

    btnActivePassengers.addEventListener('click', () => {
      if (!activeTripId) {
        alert('–°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–µ–∑–¥–∫—É.');
        return;
      }
      loadDriverTripBookings(activeTripId);
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–µ–∑–¥–æ–∫ (–ø–∞—Å—Å–∞–∂–∏—Ä)
    function loadTrips() {
      tripsList.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–µ–∑–¥–æ–∫...';

      fetch('/api/trips')
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            tripsList.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–µ–∑–¥–æ–∫: ' + data.error;
            return;
          }
          renderTrips(data.trips || []);
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–µ–∑–¥–æ–∫:', err);
          tripsList.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–µ–∑–¥–æ–∫.';
        });
    }

    function renderTrips(trips) {
      if (!trips || trips.length === 0) {
        tripsList.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫.';
        return;
      }

      tripsList.innerHTML = '';

      trips.forEach((trip) => {
        const div = document.createElement('div');
        div.className = 'trip';

        const header = document.createElement('div');
        header.className = 'trip-header';
        header.innerHTML = `
          <span>${trip.from_city} ‚Üí ${trip.to_city}</span>
          <span>${trip.price_per_seat} ‚ÇΩ/–º–µ—Å—Ç–æ</span>
        `;

        const sub = document.createElement('div');
        sub.className = 'trip-sub';
        const driverName = `${trip.first_name || ''} ${trip.last_name || ''}`.trim();
        sub.innerHTML = `
          –í–æ–¥–∏—Ç–µ–ª—å: ${driverName || '–±–µ–∑ –∏–º–µ–Ω–∏'}
          <span class="badge">${trip.seats_available}/${trip.seats_total} –º–µ—Å—Ç</span><br/>
          –í—ã–µ–∑–¥: ${trip.departure_time}
        `;

        const noteDiv = document.createElement('div');
        noteDiv.className = 'trip-note';
        if (trip.note) {
          noteDiv.textContent = '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ' + trip.note;
        }

        const btn = document.createElement('button');
        btn.className = 'primary-btn';
        btn.textContent = '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
        btn.addEventListener('click', () => {
          handleBooking(trip);
        });

        div.appendChild(header);
        div.appendChild(sub);
        if (trip.note) div.appendChild(noteDiv);
        div.appendChild(btn);

        tripsList.appendChild(div);
      });
    }

    function handleBooking(trip) {
      if (!currentTelegramUser) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫–∏.');
        return;
      }

      const maxSeats = trip.seats_available;
      if (maxSeats <= 0) {
        alert('–°–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å.');
        return;
      }

      const input = prompt(`–°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å? (–¥–æ—Å—Ç—É–ø–Ω–æ: ${maxSeats})`, '1');
      if (!input) return;

      const seats = Number(input);
      if (!Number.isFinite(seats) || seats <= 0) {
        alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç.');
        return;
      }

      if (seats > maxSeats) {
        alert('–ù–µ–ª—å–∑—è –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç.');
        return;
      }

      fetch('/api/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          trip_id: trip.id,
          seats,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
          } else {
            alert('–ë—Ä–æ–Ω—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞. –í–æ–¥–∏—Ç–µ–ª—é –∏ –≤–∞–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram.');
            loadTrips();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏.');
        });
    }

    // –ò—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫ –≤–æ–¥–∏—Ç–µ–ª—è
    btnLoadDriverTrips.addEventListener('click', () => {
      if (!currentTelegramUser) {
        driverTripsList.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.';
        return;
      }

      driverTripsList.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...';

      fetch(`/api/driver/trips?telegram_id=${encodeURIComponent(String(currentTelegramUser.id))}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverTripsList.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            renderDriverTrips(data.trips || []);
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err);
          driverTripsList.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏.';
        });
    });

    function renderDriverTrips(trips) {
      if (!trips || trips.length === 0) {
        driverTripsList.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–µ–∑–¥–æ–∫.';
        driverBookingsTitle.classList.add('hidden');
        driverBookingsList.innerHTML = '';
        return;
      }

      driverTripsList.innerHTML = '';
      driverBookingsTitle.classList.add('hidden');
      driverBookingsList.innerHTML = '';

      trips.forEach((trip) => {
        const div = document.createElement('div');
        div.className = 'trip';

        const header = document.createElement('div');
        header.className = 'trip-header';
        header.innerHTML = `
          <span>${trip.from_city} ‚Üí ${trip.to_city}</span>
          <span>${trip.price_per_seat} ‚ÇΩ/–º–µ—Å—Ç–æ</span>
        `;

        const sub = document.createElement('div');
        sub.className = 'trip-sub';
        sub.innerHTML = `
          –í—ã–µ–∑–¥: ${trip.departure_time}<br/>
          –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: ${trip.bookings_count || 0}
        `;

        const noteDiv = document.createElement('div');
        noteDiv.className = 'trip-note';
        if (trip.note) {
          noteDiv.textContent = '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ' + trip.note;
        }

        const btn = document.createElement('button');
        btn.className = 'secondary-btn';
        btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤';
        btn.addEventListener('click', () => {
          loadDriverTripBookings(trip.id);
        });

        div.appendChild(header);
        div.appendChild(sub);
        if (trip.note) div.appendChild(noteDiv);
        div.appendChild(btn);

        driverTripsList.appendChild(div);
      });
    }

    function loadDriverTripBookings(tripId) {
      driverBookingsTitle.classList.remove('hidden');
      driverBookingsList.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤...';

      fetch(
        `/api/driver/trip-bookings?telegram_id=${encodeURIComponent(
          String(currentTelegramUser.id)
        )}&trip_id=${encodeURIComponent(String(tripId))}`
      )
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            driverBookingsList.textContent = '–û—à–∏–±–∫–∞: ' + data.error;
          } else {
            renderDriverBookings(data.bookings || []);
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤:', err);
          driverBookingsList.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤.';
        });
    }

    function renderDriverBookings(bookings) {
      if (!bookings || bookings.length === 0) {
        driverBookingsList.textContent = '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ —ç—Ç–æ–π –ø–æ–µ–∑–¥–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç.';
        return;
      }

      driverBookingsList.innerHTML = '';

      bookings.forEach((b) => {
        const div = document.createElement('div');
        div.className = 'booking';

        const header = document.createElement('div');
        header.className = 'booking-header';

        const name = `${b.passenger_first_name || ''} ${b.passenger_last_name || ''}`.trim();
        const username = b.passenger_username ? `@${b.passenger_username}` : '';

        const left = document.createElement('div');
        left.textContent = name || '–ü–∞—Å—Å–∞–∂–∏—Ä –±–µ–∑ –∏–º–µ–Ω–∏';

        const statusSpan = document.createElement('span');
        statusSpan.className = 'booking-status';
        if (b.status === 'no_show') {
          statusSpan.classList.add('no-show');
          statusSpan.textContent = '–Ω–µ –ø—Ä–∏–µ—Ö–∞–ª';
        } else if (b.status === 'booked') {
          statusSpan.textContent = '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ';
        } else {
          statusSpan.textContent = b.status;
        }

        header.appendChild(left);
        header.appendChild(statusSpan);

        const meta = document.createElement('div');
        meta.className = 'booking-meta';

        const noShowText =
          b.passenger_no_show_count > 0
            ? `–ù–µ—è–≤–æ–∫: ${b.passenger_no_show_count}`
            : '–ù–µ—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç';

        meta.innerHTML = `
          ${username}<br/>
          –ú–µ—Å—Ç: ${b.seats_booked}. ${noShowText}.
        `;

        div.appendChild(header);
        div.appendChild(meta);

        if (b.status !== 'no_show') {
          const btn = document.createElement('button');
          btn.className = 'danger-btn';
          btn.textContent = '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –Ω–µ –ø—Ä–∏–µ—Ö–∞–ª';
          btn.addEventListener('click', () => {
            markNoShow(b.id);
          });
          div.appendChild(btn);
        }

        driverBookingsList.appendChild(div);
      });
    }

    function markNoShow(bookingId) {
      if (!currentTelegramUser) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
        return;
      }

      if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞ –∫–∞–∫ –Ω–µ –ø—Ä–∏–µ—Ö–∞–≤—à–µ–≥–æ?')) return;

      fetch('/api/bookings/no-show', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: String(currentTelegramUser.id),
          booking_id: bookingId,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
          } else {
            alert('–ü–∞—Å—Å–∞–∂–∏—Ä –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –Ω–µ –ø—Ä–∏–µ—Ö–∞–≤—à–∏–π.');
            btnLoadDriverTrips.click();
          }
        })
        .catch((err) => {
          console.error('–û—à–∏–±–∫–∞ no-show:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞.');
        });
    }
  </script>
</body>
</html>
